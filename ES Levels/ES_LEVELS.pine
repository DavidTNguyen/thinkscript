//@version=6
indicator("ES Levels - Dec 6", overlay=true, max_lines_count=500, max_labels_count=500)

// === ES Weekly Update - December 6, 2025 ===
// BIG PICTURE OVERVIEW - Macro structures for context
// (For detailed daily setups/intraday levels: tradecompanionsubstack.com)
//
// STRUCTURES TO NOTE:
// - November correction contained by large bull flag (yellow) - broke out this week
// - Back-tested successfully at 6805
// - Green rising channel (May recovery) - lost in November, then recovered
// - Channel support formed higher lows all week at 6847
//
// TRAJECTORY: Targets 6903, 6931 as long as above holds
// Dip there â†’ new ATHs: 6963, 7000, 7045 first batch
//
// NEXT WEEK SYNTHESIS:
// 6855-59, 6847 supports to watch for traps
// This keeps 6903, 6931 live - perhaps dip there, then 6963, 7000, 7045
//
// If 6847 fails â†’ sell to 6805
// Bulls must defend that, or finally start retracement to 6774, 6730
//
// NOTE: We don't predict - we REACT and follow price level to level.

// === ðŸŽ¯ RALLY TARGETS ===
level1 = input.float(6931, "Rally Target 3: 6931", group="ðŸŽ¯ Rally Targets")
level1_thickness = input.int(3, "Line Weight", minval=1, maxval=5, group="ðŸŽ¯ Rally Targets")
level2 = input.float(6976.75, "Rally Target 2: 6976.75", group="ðŸŽ¯ Rally Targets")
level2_thickness = input.int(3, "Line Weight", minval=1, maxval=5, group="ðŸŽ¯ Rally Targets")
level3 = input.float(6903, "Rally Target 1: 6903", group="ðŸŽ¯ Rally Targets")
level3_thickness = input.int(3, "Line Weight", minval=1, maxval=5, group="ðŸŽ¯ Rally Targets")

// === ðŸŸ¡ SUPPORT WATCH ===
level4 = input.float(6859, "Support: 6859", group="ðŸŸ¡ Support Watch")
level4_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="ðŸŸ¡ Support Watch")
level5 = input.float(6855, "Support: 6855 (trap zone)", group="ðŸŸ¡ Support Watch")
level5_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="ðŸŸ¡ Support Watch")
level6 = input.float(6847, "Channel Support: 6847 (CRITICAL)", group="ðŸŸ¡ Support Watch")
level6_thickness = input.int(3, "Line Weight", minval=1, maxval=5, group="ðŸŸ¡ Support Watch")

// === ðŸŸ¢ BACK-TESTED / DOWNSIDE ===
level7 = input.float(6805, "Back-tested: 6805 (bulls defend)", group="ðŸŸ¢ Downside Levels")
level7_thickness = input.int(3, "Line Weight", minval=1, maxval=5, group="ðŸŸ¢ Downside Levels")
level8 = input.float(6774, "Downside: 6774", group="ðŸŸ¢ Downside Levels")
level8_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="ðŸŸ¢ Downside Levels")
level9 = input.float(6730, "Retracement: 6730", group="ðŸŸ¢ Downside Levels")
level9_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="ðŸŸ¢ Downside Levels")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="Alert Settings")
alertSensitivity = input.float(0.5, "Alert Sensitivity (pts)", minval=0.1, maxval=5.0, group="Alert Settings")
showLabels = input.bool(true, "Show Price Labels", group="Display Settings")
showTable = input.bool(true, "Show Status Table", group="Display Settings")

// === Plot Levels ===
plot(level1, "6931 Rally T3", #00FFFF, level1_thickness, trackprice=false)
plot(level2, "6976.75 Rally T2", #00FFFF, level2_thickness, trackprice=false)
plot(level3, "6903 Rally T1", #00FFFF, level3_thickness, trackprice=false)
plot(level4, "6859 Support", #FFFF00, level4_thickness, trackprice=false)
plot(level5, "6855 Trap", #FFFF00, level5_thickness, trackprice=false)
plot(level6, "6847 Channel", #00FF00, level6_thickness, trackprice=false)
plot(level7, "6805 Back-test", #00FFFF, level7_thickness, trackprice=false)
plot(level8, "6774 Down", #FFA500, level8_thickness, trackprice=false)
plot(level9, "6730 Retrace", #FFA500, level9_thickness, trackprice=false)

// === Labels on Last Bar ===
if barstate.islast and showLabels
    var label lbl1 = na
    var label lbl2 = na
    var label lbl3 = na
    var label lbl4 = na
    var label lbl5 = na
    var label lbl6 = na
    var label lbl7 = na
    var label lbl8 = na
    var label lbl9 = na
    
    label.delete(lbl1)
    label.delete(lbl2)
    label.delete(lbl3)
    label.delete(lbl4)
    label.delete(lbl5)
    label.delete(lbl6)
    label.delete(lbl7)
    label.delete(lbl8)
    label.delete(lbl9)
    
    lbl1 := label.new(bar_index + 5, level1, "6931 Rally T3", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_left, size=size.small)
    lbl2 := label.new(bar_index + 5, level2, "6976.75 Rally T2", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_left, size=size.small)
    lbl3 := label.new(bar_index + 5, level3, "6903 Rally T1", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_left, size=size.small)
    lbl4 := label.new(bar_index + 5, level4, "6859 Support", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FFFF00, 80), textcolor=#FFFF00, style=label.style_label_left, size=size.small)
    lbl5 := label.new(bar_index + 5, level5, "6855 Trap", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FFFF00, 80), textcolor=#FFFF00, style=label.style_label_left, size=size.small)
    lbl6 := label.new(bar_index + 5, level6, "6847 Channel", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FF00, 80), textcolor=#00FF00, style=label.style_label_left, size=size.small)
    lbl7 := label.new(bar_index + 5, level7, "6805 Back-test", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_left, size=size.small)
    lbl8 := label.new(bar_index + 5, level8, "6774 Down", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FFA500, 80), textcolor=#FFA500, style=label.style_label_left, size=size.small)
    lbl9 := label.new(bar_index + 5, level9, "6730 Retrace", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FFA500, 80), textcolor=#FFA500, style=label.style_label_left, size=size.small)

// === Alert Conditions ===
// Rally Targets
alertcondition(ta.crossover(close, level1), "ES >> 6931", "ES >> 6931 Rally Target 3!")
alertcondition(ta.crossover(close, level2), "ES >> 6976.75", "ES >> 6976.75 Rally Target 2!")
alertcondition(ta.crossover(close, level3), "ES >> 6903", "ES >> 6903 Rally Target 1!")

// Support Watch
alertcondition(ta.cross(close, level4), "ES >> 6859", "ES >> 6859 - Support watch")
alertcondition(ta.cross(close, level5), "ES >> 6855", "ES >> 6855 - Trap zone!")

// Channel Support - CRITICAL
alertcondition(ta.crossover(close, level6), "ES RECLAIM 6847", "ES >> 6847 CHANNEL RECLAIM - Rally continues!")
alertcondition(ta.crossunder(close, level6), "ES LOST 6847", "ES << 6847 - CHANNEL BROKEN! Sell to 6805")

// Back-tested Support
alertcondition(ta.crossover(close, level7), "ES HOLD 6805", "ES >> 6805 - Back-test successful!")
alertcondition(ta.crossunder(close, level7), "ES FAILED 6805", "ES << 6805 - Back-test FAILED! Bulls must defend")

// Downside Targets
alertcondition(ta.crossunder(close, level8), "ES >> 6774", "ES >> 6774 - Downside 1")
alertcondition(ta.crossunder(close, level9), "ES >> 6730", "ES >> 6730 - RETRACEMENT ZONE")

// === Market Structure Status Table ===
var table statusTable = table.new(position.top_right, 2, 10, border_width=1)

if barstate.islast and showTable
    table.cell(statusTable, 0, 0, "ES - Dec 6", text_color=color.white, bgcolor=color.new(color.blue, 50))
    table.cell(statusTable, 1, 0, "Bull Flag Breakout", text_color=color.lime, bgcolor=color.new(color.blue, 50))
    
    table.cell(statusTable, 0, 1, "Now", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 1, str.tostring(close, "#.00"), text_color=color.aqua, bgcolor=color.new(color.gray, 50))
    
    // Channel Status
    channelStatus = close >= level6 ? "6847 CHANNEL HOLD âœ“" : "BELOW 6847"
    channelColor = close >= level6 ? color.lime : color.red
    
    table.cell(statusTable, 0, 2, "Channel", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 2, channelStatus, text_color=channelColor, bgcolor=color.new(color.gray, 50))
    
    // Trade Plan
    tradePlan = close >= level6 ? "RALLY 6903, 6931" : close >= level7 ? "DEFEND 6805" : "RETRACE 6730"
    planColor = close >= level6 ? color.lime : close >= level7 ? color.yellow : color.orange
    
    table.cell(statusTable, 0, 3, "Plan", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 3, tradePlan, text_color=planColor, bgcolor=color.new(color.gray, 50))
    
    // Back-test Status
    table.cell(statusTable, 0, 4, "6805 Back-test", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 4, "Successful âœ“", text_color=color.lime, bgcolor=color.new(color.gray, 50))
    
    // Key Levels Summary
    table.cell(statusTable, 0, 5, "Rally Targets", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 5, "6903, 6931", text_color=color.aqua, bgcolor=color.new(color.gray, 50))
    
    table.cell(statusTable, 0, 6, "Support", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 6, "6847, 6805", text_color=color.yellow, bgcolor=color.new(color.gray, 50))
    
    table.cell(statusTable, 0, 7, "Downside", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 7, "6774, 6730", text_color=color.orange, bgcolor=color.new(color.gray, 50))
    
    // Distance to 6847 Channel
    if close >= level6
        dist6 = close - level6
        table.cell(statusTable, 0, 8, "6847 Channel+", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, 8, "+" + str.tostring(dist6, "#.0") + " pts", text_color=color.lime, bgcolor=color.new(color.gray, 50))
    else
        dist6 = level6 - close
        table.cell(statusTable, 0, 8, "->6847 Channel", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, 8, str.tostring(dist6, "#.0") + " pts", text_color=color.yellow, bgcolor=color.new(color.gray, 50))
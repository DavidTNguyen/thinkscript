//@version=6
indicator("ES Levels - Dec 15", overlay=true, max_lines_count=500, max_labels_count=500)

// === ES Update - December 15, 2025 ===
// BIG PICTURE OVERVIEW - Macro structures for context
// (For detailed daily setups/intraday levels: tradecompanionsubstack.com)
//
// STRUCTURES TO NOTE:
// - Bull flag from Nov broke out early Dec
// - Large "broadening/megaphone" forming
// - Megaphone: Resistance 6939, Support 6800-05
// - Friday lost 6889 and sold off
//
// RECOVERY PLAN:
// Bulls recover 6838 -> 6877 -> 6889 -> fill megaphone
// Targets: 6910, 6939, then 6981, 7017, 7062
// If megaphone fails: 6774 bull flag, then 6732
//
// NOTE: We don't predict - we REACT and follow price level to level.

// === MEGAPHONE RESISTANCE ===
level1 = input.float(6939, "Megaphone Resistance: 6939", group="Resistance")
level1_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="Resistance")
level2 = input.float(6908, "FOMC High: 6908", group="Resistance")
level2_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="Resistance")

// === RECOVERY ZONE ===
level3 = input.float(6893, "PWH LAAF: 6893", group="Recovery Zone")
level3_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="Recovery Zone")
level4 = input.float(6866, "66 Reclaim: 6866", group="Recovery Zone")
level4_thickness = input.int(1, "Line Weight", minval=1, maxval=5, group="Recovery Zone")
level5 = input.float(6845, "45 Trap: 6845", group="Recovery Zone")
level5_thickness = input.int(1, "Line Weight", minval=1, maxval=5, group="Recovery Zone")

// === SUPPORT LEVELS (FBD) ===
level6 = input.float(6836, "36/41 FBD: 6836", group="Support FBD")
level6_thickness = input.int(1, "Line Weight", minval=1, maxval=5, group="Support FBD")
level7 = input.float(6817, "17 FBD: 6817", group="Support FBD")
level7_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="Support FBD")
level8 = input.float(6802, "PWL 11/30: 6802", group="Support FBD")
level8_thickness = input.int(2, "Line Weight", minval=1, maxval=5, group="Support FBD")

// === FAIL LEVELS ===
level9 = input.float(6796, "Deep Support: 6796", group="Fail Levels")
level9_thickness = input.int(1, "Line Weight", minval=1, maxval=5, group="Fail Levels")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="Alert Settings")
alertSensitivity = input.float(0.5, "Alert Sensitivity (pts)", minval=0.1, maxval=5.0, group="Alert Settings")
showLabels = input.bool(true, "Show Price Labels", group="Display Settings")
showTable = input.bool(true, "Show Status Table", group="Display Settings")

// === Plot Levels ===
plot(level1, "6939 Megaphone R", #FF00FF, level1_thickness, trackprice=false)
plot(level2, "6908 FOMC High", #FF00FF, level2_thickness, trackprice=false)
plot(level3, "6893 PWH LAAF", #FF6B6B, level3_thickness, trackprice=false)
plot(level4, "6866 Reclaim", #00FFFF, level4_thickness, trackprice=false)
plot(level5, "6845 Trap", #FFFF00, level5_thickness, trackprice=false)
plot(level6, "6836 FBD", #00FF00, level6_thickness, trackprice=false)
plot(level7, "6817 FBD", #00FF00, level7_thickness, trackprice=false)
plot(level8, "6802 PWL", #FFA500, level8_thickness, trackprice=false)
plot(level9, "6796 Deep", #FF0000, level9_thickness, trackprice=false)

// === Labels on Last Bar ===
if barstate.islast and showLabels
    var label lbl1 = na
    var label lbl2 = na
    var label lbl3 = na
    var label lbl4 = na
    var label lbl5 = na
    var label lbl6 = na
    var label lbl7 = na
    var label lbl8 = na
    var label lbl9 = na
    
    label.delete(lbl1)
    label.delete(lbl2)
    label.delete(lbl3)
    label.delete(lbl4)
    label.delete(lbl5)
    label.delete(lbl6)
    label.delete(lbl7)
    label.delete(lbl8)
    label.delete(lbl9)
    
    lbl1 := label.new(bar_index + 5, level1, "6939 Mega R", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FF00FF, 80), textcolor=#FF00FF, style=label.style_label_left, size=size.small)
    lbl2 := label.new(bar_index + 5, level2, "6908 FOMC", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FF00FF, 80), textcolor=#FF00FF, style=label.style_label_left, size=size.small)
    lbl3 := label.new(bar_index + 5, level3, "6893 LAAF", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FF6B6B, 80), textcolor=#FF6B6B, style=label.style_label_left, size=size.small)
    lbl4 := label.new(bar_index + 5, level4, "6866 reclaim", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_left, size=size.small)
    lbl5 := label.new(bar_index + 5, level5, "6845 trap", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FFFF00, 80), textcolor=#FFFF00, style=label.style_label_left, size=size.small)
    lbl6 := label.new(bar_index + 5, level6, "6836 FBD", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FF00, 80), textcolor=#00FF00, style=label.style_label_left, size=size.small)
    lbl7 := label.new(bar_index + 5, level7, "6817 FBD", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#00FF00, 80), textcolor=#00FF00, style=label.style_label_left, size=size.small)
    lbl8 := label.new(bar_index + 5, level8, "6802 PWL", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FFA500, 80), textcolor=#FFA500, style=label.style_label_left, size=size.small)
    lbl9 := label.new(bar_index + 5, level9, "6796 Deep", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(#FF0000, 80), textcolor=#FF0000, style=label.style_label_left, size=size.small)

// === Alert Conditions ===
// Megaphone Resistance
alertcondition(ta.crossover(close, level1), "ES >> 6939", "ES >> 6939 MEGAPHONE RESISTANCE!")
alertcondition(ta.crossover(close, level2), "ES >> 6908", "ES >> 6908 FOMC HIGH!")

// Recovery Zone
alertcondition(ta.crossover(close, level3), "ES >> 6893", "ES >> 6893 - Above PWH LAAF!")
alertcondition(ta.crossunder(close, level3), "ES << 6893", "ES << 6893 - LAAF triggered!")
alertcondition(ta.crossover(close, level4), "ES >> 6866", "ES >> 6866 - Reclaim!")
alertcondition(ta.crossover(close, level5), "ES >> 6845", "ES >> 6845 - Above trap!")
alertcondition(ta.crossunder(close, level5), "ES << 6845", "ES << 6845 - Trap level!")

// FBD Levels
alertcondition(ta.crossunder(close, level6), "ES << 6836", "ES << 6836 - FBD level")
alertcondition(ta.crossover(close, level6), "ES >> 6836", "ES >> 6836 - FBD reclaim!")
alertcondition(ta.crossunder(close, level7), "ES << 6817", "ES << 6817 - FBD level!")
alertcondition(ta.crossover(close, level7), "ES >> 6817", "ES >> 6817 - FBD reclaim!")

// PWL / Deep Levels
alertcondition(ta.crossunder(close, level8), "ES << 6802", "ES << 6802 - Below PWL!")
alertcondition(ta.crossunder(close, level9), "ES << 6796", "ES << 6796 - DEEP TARGET!")

// === Market Structure Status Table ===
var table statusTable = table.new(position.top_right, 2, 10, border_width=1)

if barstate.islast and showTable
    table.cell(statusTable, 0, 0, "ES - Dec 15", text_color=color.white, bgcolor=color.new(color.blue, 50))
    table.cell(statusTable, 1, 0, "FBD/LAAF Setup", text_color=color.fuchsia, bgcolor=color.new(color.blue, 50))
    
    table.cell(statusTable, 0, 1, "Now", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 1, str.tostring(close, "#.00"), text_color=color.aqua, bgcolor=color.new(color.gray, 50))
    
    // Position Status
    posStatus = close >= level2 ? "ABOVE FOMC" : close >= level3 ? "LAAF ZONE" : close >= level5 ? "RECOVERY" : close >= level7 ? "FBD ZONE" : "BELOW FBD"
    posColor = close >= level2 ? color.lime : close >= level3 ? color.yellow : close >= level5 ? color.aqua : close >= level7 ? color.green : color.red
    
    table.cell(statusTable, 0, 2, "Position", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 2, posStatus, text_color=posColor, bgcolor=color.new(color.gray, 50))
    
    // Trade Plan
    tradePlan = close >= level2 ? "T: 6939" : close >= level5 ? "RECLAIM 6893" : close >= level7 ? "HOLD FBD" : "WATCH PWL"
    planColor = close >= level2 ? color.fuchsia : close >= level5 ? color.yellow : close >= level7 ? color.green : color.red
    
    table.cell(statusTable, 0, 3, "Plan", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 3, tradePlan, text_color=planColor, bgcolor=color.new(color.gray, 50))
    
    // Key Concepts
    table.cell(statusTable, 0, 4, "LAAF", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 4, "Look Above Fail", text_color=#FF6B6B, bgcolor=color.new(color.gray, 50))
    
    table.cell(statusTable, 0, 5, "FBD", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 5, "Failed Breakdown", text_color=color.lime, bgcolor=color.new(color.gray, 50))
    
    // Key Levels
    table.cell(statusTable, 0, 6, "Resistance", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 6, "6908 FOMC, 6939", text_color=color.fuchsia, bgcolor=color.new(color.gray, 50))
    
    table.cell(statusTable, 0, 7, "FBD Levels", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 7, "6836, 6817", text_color=color.lime, bgcolor=color.new(color.gray, 50))
    
    // Distance to key level
    if close < level3
        dist3 = level3 - close
        table.cell(statusTable, 0, 8, "->6893 LAAF", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, 8, str.tostring(dist3, "#.0") + " pts", text_color=color.yellow, bgcolor=color.new(color.gray, 50))
    else
        dist1 = level1 - close
        table.cell(statusTable, 0, 8, "->6939", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, 8, str.tostring(dist1, "#.0") + " pts", text_color=color.fuchsia, bgcolor=color.new(color.gray, 50))
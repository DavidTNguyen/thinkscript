//@version=5
indicator("MANCINI ES Levels: Dec 3 - 3 Day Flag Building", overlay=true, max_lines_count=500, max_labels_count=500)

// === MANCINI ES Levels: Weekly Plan ===
// Updated: December 3, 2025 (PM Update)
// 
// CONTEXT:
// 6842 target #2 HIT! 
// As posted: 6830 reclaim â†’ targets 6835, 6842 (BOTH HIT!)
// Newsletter readers got lower 6818 Failed Breakdown entry
// ES remains in congested chop - building 3 day flag
// **ALWAYS** take profits level to level, leave runner. Moves don't last!
// 
// PLAN:
// Upside targets: 6853, 6862+ above
// Support: 6830 reclaim (proven), 6825 magnet, 6818 (failed breakdown entry)
// Downside: 6805, 6796 if breakdown

// === UPSIDE TARGETS ===
level1 = input.float(6862, "Upside: 6862 Extended Target", group="ðŸŽ¯ Upside")
level1_thickness = input.int(2, "6862 Line Weight", minval=1, maxval=5, group="ðŸŽ¯ Upside")
level2 = input.float(6853, "Upside: 6853 Next Above", group="ðŸŽ¯ Upside")
level2_thickness = input.int(2, "6853 Line Weight", minval=1, maxval=5, group="ðŸŽ¯ Upside")

// === HIT LEVELS ===
level3 = input.float(6842, "HIT: 6842 Target #2 *", group="âœ“ Hit Levels")
level3_thickness = input.int(1, "6842 Line Weight", minval=1, maxval=5, group="âœ“ Hit Levels")
level4 = input.float(6835, "HIT: 6835 Target #1 *", group="âœ“ Hit Levels")
level4_thickness = input.int(1, "6835 Line Weight", minval=1, maxval=5, group="âœ“ Hit Levels")

// === SUPPORT LEVELS ===
level5 = input.float(6830, "Support: 6830 Reclaim (proven)", group="ðŸŸ¢ Support")
level5_thickness = input.int(2, "6830 Line Weight", minval=1, maxval=5, group="ðŸŸ¢ Support")
level6 = input.float(6825, "Support: 6825 Magnet ðŸ§²", group="ðŸŸ¢ Support")
level6_thickness = input.int(3, "6825 Line Weight", minval=1, maxval=5, group="ðŸŸ¢ Support")
level7 = input.float(6818, "Support: 6818 Failed Breakdown (newsletter)", group="ðŸŸ¢ Support")
level7_thickness = input.int(2, "6818 Line Weight", minval=1, maxval=5, group="ðŸŸ¢ Support")

// === DOWNSIDE LEVELS ===
level8 = input.float(6805, "Downside: 6805 Target 1", group="ðŸ”´ Downside")
level8_thickness = input.int(2, "6805 Line Weight", minval=1, maxval=5, group="ðŸ”´ Downside")
level9 = input.float(6796, "Downside: 6796 Target 2", group="ðŸ”´ Downside")
level9_thickness = input.int(2, "6796 Line Weight", minval=1, maxval=5, group="ðŸ”´ Downside")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="Alert Settings")
alertSensitivity = input.float(0.5, "Alert Sensitivity (pts)", minval=0.1, maxval=5.0, group="Alert Settings")

// === Plot Upside Targets ===
plot(level1, "6862 Extended", color=color.new(color.aqua, 0), linewidth=level1_thickness, style=plot.style_line)
plot(level2, "6853 Next Above", color=color.new(color.aqua, 0), linewidth=level2_thickness, style=plot.style_line)

// === Plot Hit Levels ===
plot(level3, "6842 HIT *", color=color.new(color.gray, 0), linewidth=level3_thickness, style=plot.style_line)
plot(level4, "6835 HIT *", color=color.new(color.gray, 0), linewidth=level4_thickness, style=plot.style_line)

// === Plot Support ===
plot(level5, "6830 Reclaim", color=color.new(color.aqua, 0), linewidth=level5_thickness, style=plot.style_line)
plot(level6, "6825 Magnet", color=color.new(color.yellow, 0), linewidth=level6_thickness, style=plot.style_line)
plot(level7, "6818 FB Entry", color=color.new(color.green, 0), linewidth=level7_thickness, style=plot.style_line)

// === Plot Downside ===
plot(level8, "6805 Downside", color=color.new(color.orange, 0), linewidth=level8_thickness, style=plot.style_line)
plot(level9, "6796 Downside", color=color.new(color.red, 0), linewidth=level9_thickness, style=plot.style_line)

// === Labels on Last Bar ===
if barstate.islast
    label.new(bar_index, level1, "6862 Target", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.aqua, 80), textcolor=color.aqua, style=label.style_label_left, size=size.small)
    label.new(bar_index, level2, "6853 Next", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.aqua, 80), textcolor=color.aqua, style=label.style_label_left, size=size.small)
    label.new(bar_index, level3, "6842 HIT *", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.gray, 80), textcolor=color.gray, style=label.style_label_left, size=size.small)
    label.new(bar_index, level4, "6835 HIT *", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.gray, 80), textcolor=color.gray, style=label.style_label_left, size=size.small)
    label.new(bar_index, level5, "6830 Reclaim âœ“", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.aqua, 80), textcolor=color.aqua, style=label.style_label_right, size=size.small)
    label.new(bar_index, level6, "6825 ðŸ§²", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.yellow, 80), textcolor=color.yellow, style=label.style_label_right, size=size.normal)
    label.new(bar_index, level7, "6818 FB", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.green, 80), textcolor=color.green, style=label.style_label_right, size=size.small)
    label.new(bar_index, level8, "6805 Down", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.orange, 80), textcolor=color.orange, style=label.style_label_right, size=size.small)
    label.new(bar_index, level9, "6796 Down", xloc=xloc.bar_index, yloc=yloc.price, color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_right, size=size.small)

// === Alert Conditions ===
// RESISTANCE Breakout Alerts
alertcondition(ta.crossover(close, overnightLow), "ES RECLAIM Overnight Low", "ES RECLAIMED Overnight Low - Pop Setup!")
alertcondition(ta.crossover(close, level4), "ES ABOVE R1: 6815", "ES ABOVE R1: 6815!")
alertcondition(ta.crossover(close, level3), "ES ABOVE R2: 6841", "ES ABOVE R2: 6841 - Bulls Fighting Back!")
alertcondition(ta.crossover(close, level2), "ES ABOVE R3: 6851 MACRO", "ES ABOVE R3: 6851 - BULLS REGAIN MACRO CONTROL!")
alertcondition(ta.crossover(close, level1), "ES ABOVE R4: 6869", "ES ABOVE R4: 6869 - Extended Target!")

// SUPPORT Break Alerts
alertcondition(ta.crossunder(close, overnightLow), "ES LOST Overnight Low", "ES LOST Overnight Low - Watch 6782-85!")
alertcondition(ta.crossunder(close, level5), "ES BELOW S1: 6785", "ES BELOW S1: 6785 - Next 6782!")
alertcondition(ta.crossunder(close, level6), "ES BELOW S2: 6782", "ES BELOW S2: 6782 - 6766 Below!")
alertcondition(ta.crossunder(close, level7), "ES BELOW S3: 6766", "ES BELOW S3: 6766 - Support Lost!")

// Testing Key Levels
testingONLow = close >= overnightLow - alertSensitivity and close <= overnightLow + alertSensitivity
testingR2 = close >= level3 - alertSensitivity and close <= level3 + alertSensitivity
testingMacro = close >= level2 - alertSensitivity and close <= level2 + alertSensitivity

alertcondition(testingONLow, "ES Testing Overnight Low", "ES Testing Overnight Low - Critical Reclaim Level")
alertcondition(testingR2, "ES Testing R2: 6841", "ES Testing R2: 6841 - Where Bears Took Over")
alertcondition(testingMacro, "ES Testing R3: 6851", "ES Testing R3: 6851 - MACRO CONTROL Level")

// Bounce/Rejection Alerts
bounceONLow = low[1] <= overnightLow and close > overnightLow + 3
rejectR2 = high[1] >= level3 and close < level3 - 3
rejectMacro = high[1] >= level2 and close < level2 - 3

alertcondition(bounceONLow, "ES BOUNCE from ON Low", "ES BOUNCE from Overnight Low! Pop Active")
alertcondition(rejectR2, "ES REJECTION at R2: 6841", "ES REJECTION at R2: 6841 - Bears Still Control")
alertcondition(rejectMacro, "ES REJECTION at R3: 6851", "ES REJECTION at R3: 6851 - Macro Control Denied")

// === Market Structure Status Table ===
var table statusTable = table.new(position.top_right, 2, 12, border_width=1)

if barstate.islast
    table.cell(statusTable, 0, 0, "BEARS CONTROL AFTER 6841", text_color=color.white, bgcolor=color.new(color.red, 50))
    table.cell(statusTable, 1, 0, "Hit 6851 & Sold", text_color=color.yellow, bgcolor=color.new(color.red, 50))
    
    table.cell(statusTable, 0, 1, "Now", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 1, str.tostring(close, "#.00"), text_color=color.aqua, bgcolor=color.new(color.gray, 50))
    
    // Market Structure
    structure = close >= level2 ? "ABOVE 6851 - BULLS MACRO CONTROL!" : close >= level3 ? "ABOVE 6841 - BULLS FIGHTING" : close >= overnightLow ? "ABOVE ON LOW - POP SETUP" : close >= level5 ? "BELOW ON LOW - NEXT 6782-85" : "BELOW 6785 - WATCH 6766"
    structureColor = close >= level2 ? color.lime : close >= level3 ? color.aqua : close >= overnightLow ? color.yellow : close >= level5 ? color.orange : color.red
    
    table.cell(statusTable, 0, 2, "Structure", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 2, structure, text_color=structureColor, bgcolor=color.new(color.gray, 50))
    
    // Control Status
    control = close >= level2 ? "BULLS MACRO" : "BEARS CONTROL"
    controlColor = close >= level2 ? color.lime : color.red
    
    table.cell(statusTable, 0, 3, "Control", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 3, control, text_color=controlColor, bgcolor=color.new(color.gray, 50))
    
    // Trade Plan
    tradePlan = close >= level2 ? "MACRO RECLAIMED - 6869+" : close >= overnightLow ? "RECLAIM: TARGET 6815-41-51" : "MUST RECLAIM ON LOW"
    planColor = close >= level2 ? color.lime : close >= overnightLow ? color.yellow : color.red
    
    table.cell(statusTable, 0, 4, "Trade Plan", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 4, tradePlan, text_color=planColor, bgcolor=color.new(color.gray, 50))
    
    // Distance to Key Levels
    distToONLow = overnightLow - close
    distTo6815 = level4 - close
    distTo6841 = level3 - close
    distTo6851 = level2 - close
    distTo6869 = level1 - close
    distFrom6785 = close - level5
    distFrom6782 = close - level6
    distFrom6766 = close - level7
    
    rowNum = 5
    
    if close < overnightLow
        table.cell(statusTable, 0, rowNum, "->ON Low", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distToONLow, "#.0") + " pts", text_color=color.yellow, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    if close < level4
        table.cell(statusTable, 0, rowNum, "->R1", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6815, "#.0") + " pts", text_color=color.aqua, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    if close < level3
        table.cell(statusTable, 0, rowNum, "->R2 (Bears)", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6841, "#.0") + " pts", text_color=color.orange, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    if close < level2
        table.cell(statusTable, 0, rowNum, "->R3 (MACRO)", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6851, "#.0") + " pts", text_color=color.red, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    if close < level1
        table.cell(statusTable, 0, rowNum, "->R4", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6869, "#.0") + " pts", text_color=color.fuchsia, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    if close >= level5
        table.cell(statusTable, 0, rowNum, "S1+", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, "+" + str.tostring(distFrom6785, "#.0") + " pts", text_color=color.lime, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    if close >= level6
        table.cell(statusTable, 0, rowNum, "S2+", text_color=color.white, bgcolor=color.new(color.gray, 50))
        table.cell(statusTable, 1, rowNum, "+" + str.tostring(distFrom6782, "#.0") + " pts", text_color=color.lime, bgcolor=color.new(color.gray, 50))
        rowNum += 1
    
    // Context
    table.cell(statusTable, 0, 10, "R:", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 10, "6869-6851-6841-6815", text_color=color.fuchsia, bgcolor=color.new(color.gray, 50))
    
    table.cell(statusTable, 0, 11, "S:", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 11, "6785-6782-6766", text_color=color.lime, bgcolor=color.new(color.gray, 50))
    
    table.cell(statusTable, 0, 12, "Key:", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(statusTable, 1, 12, "6851=Macro, ON Low=Pop", text_color=color.yellow, bgcolor=color.new(color.gray, 50))

// Background color based on structure
bgColor = close >= level2 ? color.new(color.lime, 95) : close >= level3 ? color.new(color.aqua, 95) : close >= overnightLow ? color.new(color.yellow, 95) : close >= level5 ? color.new(color.orange, 95) : color.new(color.red, 95)

bgcolor(bgColor, title="Structure Background")
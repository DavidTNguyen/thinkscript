//@version=6
indicator("ES Levels", overlay=true, max_lines_count=500, max_labels_count=500)

// === ES Levels: Flag Breakout - Runner Targets ===
// Updated: December 2, 2025
// RECLAIM EXECUTED! 6834 triggered → 6842 → 6852 ✓
// Flag delivered: 6812-6843 with 6825 magnet
// Clean breakout sequence after reclaim
// Runner targets: 6862, 6868, 6877+

// === RESISTANCE LEVELS (Runner Targets) ===
level1 = input.float(6877, "R4: Runner continuation", group="Resistance")
level1_thickness = input.int(2, "R4 Line Weight", minval=1, maxval=5, group="Resistance")
level2 = input.float(6868, "R3: Target 2", group="Resistance")
level2_thickness = input.int(2, "R3 Line Weight", minval=1, maxval=5, group="Resistance")
level3 = input.float(6862, "R2: Next Target", group="Resistance")
level3_thickness = input.int(2, "R2 Line Weight", minval=1, maxval=5, group="Resistance")
level4 = input.float(6852, "R1: HIT ✓", group="Resistance")
level4_thickness = input.int(1, "R1 Line Weight", minval=1, maxval=5, group="Resistance")

// === SUPPORT LEVELS ===
level5 = input.float(6842, "S1: HIT ✓", group="Support")
level5_thickness = input.int(1, "S1 Line Weight", minval=1, maxval=5, group="Support")
level6 = input.float(6834, "S2: Reclaim trigger (now support)", group="Support")
level6_thickness = input.int(3, "S2 Line Weight", minval=1, maxval=5, group="Support")
level7 = input.float(6825, "S3: Magnet", group="Support")
level7_thickness = input.int(2, "S3 Line Weight", minval=1, maxval=5, group="Support")

// Flag Structure
flagTop = input.float(6843, "Flag Top: Back-tested", group="Key Levels")
flagTop_thickness = input.int(2, "Flag Top Line Weight", minval=1, maxval=5, group="Key Levels")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="Alert Settings")
alertSensitivity = input.float(0.5, "Alert Sensitivity (pts)", minval=0.1, maxval=5.0, group="Alert Settings")
showLabels = input.bool(true, "Show Price Labels", group="Display Settings")
showTable = input.bool(true, "Show Status Table", group="Display Settings")

// === Plot Resistance Levels ===
plot(level1, "R4: 6877+ Runner", #00FFFF, level1_thickness, trackprice=true)
plot(level2, "R3: 6868", #00FFFF, level2_thickness, trackprice=true)
plot(level3, "R2: 6862 Next", #00FFFF, level3_thickness, trackprice=true)
plot(level4, "R1: 6852 HIT", #808080, level4_thickness, plot.style_linebr, trackprice=true)

// === Plot Key Level - Flag Top ===
plot(flagTop, "Flag Top: 6843", #FF00FF, flagTop_thickness, trackprice=true)

// === Plot Support Levels ===
plot(level5, "S1: 6842 HIT", #808080, level5_thickness, plot.style_linebr, trackprice=true)
plot(level6, "S2: 6834 Support", #00FF00, level6_thickness, trackprice=true)
plot(level7, "S3: 6825 Magnet", #FFFF00, level7_thickness, trackprice=true)

// === Labels on Last Bar ===
if barstate.islast and showLabels
    var label lbl1 = na
    var label lbl2 = na
    var label lbl3 = na
    var label lbl4 = na
    var label lblFlag = na
    var label lbl5 = na
    var label lbl6 = na
    var label lbl7 = na
    
    label.delete(lbl1)
    label.delete(lbl2)
    label.delete(lbl3)
    label.delete(lbl4)
    label.delete(lblFlag)
    label.delete(lbl5)
    label.delete(lbl6)
    label.delete(lbl7)
    
    lbl1 := label.new(bar_index + 5, level1, "R4: 6877+ Runner", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_down, size=size.small)
    lbl2 := label.new(bar_index + 5, level2, "R3: 6868", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_down, size=size.small)
    lbl3 := label.new(bar_index + 5, level3, "R2: 6862 Next", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#00FFFF, 80), textcolor=#00FFFF, style=label.style_label_down, size=size.small)
    lbl4 := label.new(bar_index + 5, level4, "R1: 6852 HIT ✓", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#808080, 80), textcolor=#808080, style=label.style_label_down, size=size.small)
    lblFlag := label.new(bar_index + 5, flagTop, "Flag Top: 6843", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#FF00FF, 80), textcolor=#FF00FF, style=label.style_label_down, size=size.normal)
    lbl5 := label.new(bar_index + 5, level5, "S1: 6842 HIT ✓", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#808080, 80), textcolor=#808080, style=label.style_label_down, size=size.small)
    lbl6 := label.new(bar_index + 5, level6, "S2: 6834 Support", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#00FF00, 80), textcolor=#00FF00, style=label.style_label_down, size=size.small)
    lbl7 := label.new(bar_index + 5, level7, "S3: 6825 Magnet", xloc=xloc.bar_index, yloc=yloc.abovebar, color=color.new(#FFFF00, 80), textcolor=#FFFF00, style=label.style_label_down, size=size.small)

// === Alert Conditions ===
// RUNNER TARGET Alerts
alertcondition(ta.crossover(close, level3), "ES ABOVE R2: 6862", "ES ABOVE R2: 6862 - Next Runner Target!")
alertcondition(ta.crossover(close, level2), "ES ABOVE R3: 6868", "ES ABOVE R3: 6868 - Runner Active!")
alertcondition(ta.crossover(close, level1), "ES ABOVE R4: 6877+", "ES ABOVE R4: 6877+ - Runner Continuation!")

// HIT LEVEL Alerts
alertcondition(ta.crossover(close, level4), "ES AT 6852", "ES AT 6852 - First Target Hit!")
alertcondition(ta.crossover(close, level5), "ES AT 6842", "ES AT 6842 - Flag Target Hit!")

// FLAG STRUCTURE Alerts
alertcondition(ta.crossover(close, flagTop), "ES ABOVE Flag Top 6843", "ES ABOVE Flag Top 6843 - Breakout Confirmed!")
alertcondition(ta.crossunder(close, flagTop), "ES BELOW Flag Top 6843", "ES BELOW Flag Top 6843 - Back-test!")

// SUPPORT Break Alerts
alertcondition(ta.crossunder(close, level6), "ES BELOW 6834 Support", "ES BELOW 6834 Support - Lost Reclaim Trigger!")
alertcondition(ta.crossunder(close, level7), "ES BELOW 6825 Magnet", "ES BELOW 6825 Magnet - Flag Support Test!")

// Testing Key Levels
testing6862 = close >= level3 - alertSensitivity and close <= level3 + alertSensitivity
testing6868 = close >= level2 - alertSensitivity and close <= level2 + alertSensitivity
testing6834 = close >= level6 - alertSensitivity and close <= level6 + alertSensitivity

alertcondition(testing6862, "ES Testing 6862", "ES Testing 6862 - Next Runner Target")
alertcondition(testing6868, "ES Testing 6868", "ES Testing 6868 - Target 2")
alertcondition(testing6834, "ES Testing 6834", "ES Testing 6834 Support - Former Reclaim Trigger")

// Bounce/Rejection Alerts
bounce6834 = low[1] <= level6 and close > level6 + 3
reject6862 = high[1] >= level3 and close < level3 - 3
reject6868 = high[1] >= level2 and close < level2 - 3

alertcondition(bounce6834, "ES BOUNCE from 6834", "ES BOUNCE from 6834 Support!")
alertcondition(reject6862, "ES REJECTION at 6862", "ES REJECTION at 6862 - Target Denied")
alertcondition(reject6868, "ES REJECTION at 6868", "ES REJECTION at 6868 - Runner Stalled")

// === Market Structure Status Table ===
var table statusTable = table.new(position.top_right, 2, 13, border_width=1)

if barstate.islast and showTable
    table.cell(statusTable, 0, 0, "FLAG BREAKOUT - RUNNERS ACTIVE", text_color=#FFFFFF, bgcolor=color.new(#00FF00, 50))
    table.cell(statusTable, 1, 0, "6834 Reclaim \u2192 6842 \u2192 6852 \u2713", text_color=#00FF00, bgcolor=color.new(#00FF00, 50))
    
    table.cell(statusTable, 0, 1, "Now", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 1, str.tostring(close, "#.00"), text_color=#00FFFF, bgcolor=color.new(#808080, 50))
    
    // Market Structure
    structure = close >= level1 ? "ABOVE 6877 - RUNNER CONTINUATION!" : close >= level2 ? "ABOVE 6868 - TARGET 2!" : close >= level3 ? "ABOVE 6862 - NEXT TARGET!" : close >= level4 ? "ABOVE 6852 - WATCH 6862" : close >= level6 ? "ABOVE 6834 - SUPPORT HELD" : "BELOW 6834 - LOST SUPPORT"
    structureColor = close >= level1 ? #00FF00 : close >= level2 ? #00FF00 : close >= level3 ? #00FFFF : close >= level4 ? #FFFF00 : close >= level6 ? #00FF00 : #FF0000
    
    table.cell(statusTable, 0, 2, "Structure", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 2, structure, text_color=structureColor, bgcolor=color.new(#808080, 50))
    
    // Control Status
    control = close >= level3 ? "BULLS - RUNNERS" : close >= level6 ? "BULLS - BREAKOUT" : "NEUTRAL"
    controlColor = close >= level3 ? #00FF00 : close >= level6 ? #FFFF00 : #808080
    
    table.cell(statusTable, 0, 3, "Control", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 3, control, text_color=controlColor, bgcolor=color.new(#808080, 50))
    
    // Trade Plan
    tradePlan = close >= level3 ? "RUNNER: 6868 \u2192 6877+" : close >= level6 ? "BREAKOUT: TARGET 6862-68-77" : "MUST HOLD 6834"
    planColor = close >= level3 ? #00FF00 : close >= level6 ? #FFFF00 : #FF0000
    
    table.cell(statusTable, 0, 4, "Trade Plan", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 4, tradePlan, text_color=planColor, bgcolor=color.new(#808080, 50))
    
    // Distance to Key Levels
    distTo6862 = level3 - close
    distTo6868 = level2 - close
    distTo6877 = level1 - close
    distFrom6852 = close - level4
    distFrom6842 = close - level5
    distFrom6834 = close - level6
    
    rowNum = 5
    
    if close < level3
        table.cell(statusTable, 0, rowNum, "->6862 Next", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6862, "#.0") + " pts", text_color=#00FFFF, bgcolor=color.new(#808080, 50))
        rowNum += 1
    
    if close < level2
        table.cell(statusTable, 0, rowNum, "->6868", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6868, "#.0") + " pts", text_color=#00FFFF, bgcolor=color.new(#808080, 50))
        rowNum += 1
    
    if close < level1
        table.cell(statusTable, 0, rowNum, "->6877+ Runner", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
        table.cell(statusTable, 1, rowNum, str.tostring(distTo6877, "#.0") + " pts", text_color=#00FFFF, bgcolor=color.new(#808080, 50))
        rowNum += 1
    
    if close >= level4
        table.cell(statusTable, 0, rowNum, "6852+", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
        table.cell(statusTable, 1, rowNum, "+" + str.tostring(distFrom6852, "#.0") + " pts", text_color=#00FF00, bgcolor=color.new(#808080, 50))
        rowNum += 1
    
    if close >= level6
        table.cell(statusTable, 0, rowNum, "6834+ Support", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
        table.cell(statusTable, 1, rowNum, "+" + str.tostring(distFrom6834, "#.0") + " pts", text_color=#00FF00, bgcolor=color.new(#808080, 50))
        rowNum += 1
    
    // Context
    table.cell(statusTable, 0, 10, "R:", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 10, "6877-6868-6862", text_color=#00FFFF, bgcolor=color.new(#808080, 50))
    
    table.cell(statusTable, 0, 11, "S:", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 11, "6834-6825 (Flag)", text_color=#00FF00, bgcolor=color.new(#808080, 50))
    
    table.cell(statusTable, 0, 12, "Key:", text_color=#FFFFFF, bgcolor=color.new(#808080, 50))
    table.cell(statusTable, 1, 12, "Hit: 6852-6842 \u2713", text_color=#FFFF00, bgcolor=color.new(#808080, 50))
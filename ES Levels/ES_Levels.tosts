# === ES Plan - Clean Execution Focus (Level-to-Level) ===
# BIG PICTURE OVERVIEW
#
# CONTEXT:
# - ğŸ”¥ FULL SLATE + BONUS RAN! ğŸ”¥
# - 6964 bear trap/FBD was the long trigger â†’ swept 6956, trapped, recovered
# - ğŸ¯ 7002 HIT, 7006 HIT, 7011 ~HIT
# - RIDE RUNNER ğŸ‡
#
# PLAN:
# - ğŸ‚ish: 7020 above. Ride runner!
# - ğŸ»ish: Below 6991 micro support
#
# SUPPORTS:
# - 6991 (micro support)
# - 6964 (FBD trap level)
# NOTE: Ride runner, protect gains.

# === KEY LEVELS ===
input level1 = 7020;  # Bonus ğŸ¯
input level1_thickness = 2;
input level2 = 7011;  # [x] Bonus
input level2_thickness = 2;
input level3 = 7006;  # [x] Bonus
input level3_thickness = 2;
input level4 = 7002;  # [x] Major
input level4_thickness = 2;
input level5 = 6991;  # Micro Support
input level5_thickness = 3;
input level6 = 6986;  # [x]
input level6_thickness = 2;
input level7 = 6977;  # [x]
input level7_thickness = 2;
input level8 = 6964;  # FBD Trap Level
input level8_thickness = 3;
input level9 = 6953;  # Support
input level9_thickness = 2;
input level10 = 6945; # Key Support - Sell<
input level10_thickness = 3;
input level11 = 6935; # ğŸ‚ Flag
input level11_thickness = 2;
input level12 = 6925; # Major ğŸ’ª
input level12_thickness = 2;

# Alert Settings
input enableAlerts = yes;

# Label Visibility
input showLabels = yes;

input bubblesBeforeLast = -8;
def isLastBar1 = IsNaN(close[-1]) and !IsNaN(close);
def isLastBar = isLastBar1[-bubblesBeforeLast];

# Position detection
def aboveLevel1 = close > level1;
def atLevel1 = close >= level1 - 2 and close <= level1 + 2;
def aboveLevel2 = close > level2;
def atLevel2 = close >= level2 - 2 and close <= level2 + 2;
def aboveLevel3 = close > level3;
def atLevel3 = close >= level3 - 2 and close <= level3 + 2;
def aboveLevel4 = close > level4;
def atLevel4 = close >= level4 - 2 and close <= level4 + 2;
def aboveLevel5 = close > level5;
def atLevel5 = close >= level5 - 2 and close <= level5 + 2;
def aboveLevel6 = close > level6;
def atLevel6 = close >= level6 - 2 and close <= level6 + 2;
def aboveLevel7 = close > level7;
def atLevel7 = close >= level7 - 2 and close <= level7 + 2;
def aboveLevel8 = close > level8;
def atLevel8 = close >= level8 - 2 and close <= level8 + 2;
def aboveLevel9 = close > level9;
def atLevel9 = close >= level9 - 2 and close <= level9 + 2;
def aboveLevel10 = close > level10;
def atLevel10 = close >= level10 - 2 and close <= level10 + 2;
def aboveLevel11 = close > level11;
def atLevel11 = close >= level11 - 2 and close <= level11 + 2;
def aboveLevel12 = close > level12;
def atLevel12 = close >= level12 - 2 and close <= level12 + 2;

# === NWOG (New Week Opening Gap) ===
input showNWOG = yes;
def nwog_open = open(period = AggregationPeriod.WEEK);
def nwog_close = close(period = AggregationPeriod.WEEK)[1];
def nwog_high = Max(nwog_open, nwog_close);
def nwog_low = Min(nwog_open, nwog_close);
def nwog_mid = (nwog_high + nwog_low) / 2;

def current_nwog_open = HighestAll(if IsNaN(close[-1]) and !IsNaN(close) then nwog_open else Double.NaN);
def current_nwog_close = HighestAll(if IsNaN(close[-1]) and !IsNaN(close) then nwog_close else Double.NaN);
def isCurrentGap = nwog_open == current_nwog_open and nwog_close == current_nwog_close;

# === LEVEL PLOTS ===
plot L1 = level1;
L1.SetDefaultColor(Color.MAGENTA);
L1.SetLineWeight(level1_thickness);
L1.SetStyle(Curve.SHORT_DASH);

plot L2 = level2;
L2.SetDefaultColor(Color.MAGENTA);
L2.SetLineWeight(level2_thickness);
L2.SetStyle(Curve.SHORT_DASH);

plot L3 = level3;
L3.SetDefaultColor(Color.MAGENTA);
L3.SetLineWeight(level3_thickness);
L3.SetStyle(Curve.SHORT_DASH);

plot L4 = level4;
L4.SetDefaultColor(Color.ORANGE);
L4.SetLineWeight(level4_thickness);
L4.SetStyle(Curve.FIRM);

plot L5 = level5;
L5.SetDefaultColor(Color.ORANGE);
L5.SetLineWeight(level5_thickness);
L5.SetStyle(Curve.FIRM);

plot L6 = level6;
L6.SetDefaultColor(Color.ORANGE);
L6.SetLineWeight(level6_thickness);
L6.SetStyle(Curve.FIRM);

plot L7 = level7;
L7.SetDefaultColor(Color.CYAN);
L7.SetLineWeight(level7_thickness);
L7.SetStyle(Curve.FIRM);

plot L8 = level8;
L8.SetDefaultColor(Color.CYAN);
L8.SetLineWeight(level8_thickness);
L8.SetStyle(Curve.SHORT_DASH);

plot L9 = if level9 > 0 then level9 else Double.NaN;
L9.SetDefaultColor(Color.YELLOW);
L9.SetLineWeight(level9_thickness);
L9.SetStyle(Curve.FIRM);

plot L10 = if level10 > 0 then level10 else Double.NaN;
L10.SetDefaultColor(Color.RED);
L10.SetLineWeight(level10_thickness);
L10.SetStyle(Curve.SHORT_DASH);

plot L11 = if level11 > 0 then level11 else Double.NaN;
L11.SetDefaultColor(Color.RED);
L11.SetLineWeight(level11_thickness);
L11.SetStyle(Curve.SHORT_DASH);

plot L12 = if level12 > 0 then level12 else Double.NaN;
L12.SetDefaultColor(Color.GRAY);
L12.SetLineWeight(level12_thickness);
L12.SetStyle(Curve.SHORT_DASH);

# === NWOG PLOTS ===
plot pNWOG_High = if showNWOG and isCurrentGap then nwog_high else Double.NaN;
pNWOG_High.SetDefaultColor(Color.VIOLET);
pNWOG_High.SetLineWeight(1);
pNWOG_High.SetStyle(Curve.LONG_DASH);

plot pNWOG_Low = if showNWOG and isCurrentGap then nwog_low else Double.NaN;
pNWOG_Low.SetDefaultColor(Color.VIOLET);
pNWOG_Low.SetLineWeight(1);
pNWOG_Low.SetStyle(Curve.LONG_DASH);

plot pNWOG_Mid = if showNWOG and isCurrentGap then nwog_mid else Double.NaN;
pNWOG_Mid.SetDefaultColor(Color.VIOLET);
pNWOG_Mid.SetLineWeight(1);
pNWOG_Mid.SetStyle(Curve.SHORT_DASH);

# === CHART BUBBLES ===
AddChartBubble(isLastBar, level1, "20 ğŸ¯", Color.MAGENTA, yes);
AddChartBubble(isLastBar, level2, "11 [x]", Color.MAGENTA, yes);
AddChartBubble(isLastBar, level3, "06 [x]", Color.MAGENTA, yes);
AddChartBubble(isLastBar, level4, "02 [x]", Color.ORANGE, yes);
AddChartBubble(isLastBar, level5, "91 Î¼Sup", Color.CYAN, yes);
AddChartBubble(isLastBar, level6, "86 [x]", Color.ORANGE, yes);
AddChartBubble(isLastBar, level7, "77 [x]", Color.ORANGE, yes);
AddChartBubble(isLastBar, level8, "64 FBD", Color.CYAN, yes);
AddChartBubble(isLastBar, level9, "53 ğŸ’ª", Color.YELLOW, no);
AddChartBubble(isLastBar and level10 > 0, level10, "45 Sell<", Color.YELLOW, no);
AddChartBubble(isLastBar and level11 > 0, level11, "35 ğŸ‚", Color.CYAN, no);
AddChartBubble(isLastBar and level12 > 0, level12, "25 ğŸ’ª", Color.CYAN, no);
AddChartBubble(isLastBar and showNWOG, nwog_high, "NWOG H", Color.VIOLET, yes);
AddChartBubble(isLastBar and showNWOG, nwog_low, "NWOG L", Color.VIOLET, no);
AddChartBubble(isLastBar and showNWOG, nwog_mid, "NWOG 50%", Color.VIOLET, yes);

# === ALERT SYSTEM ===

# LEVEL 1 - 7020 Bonus ğŸ¯
Alert(enableAlerts and close crosses above level1, "ES >> 7020 - BONUS ğŸ¯!", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level1, "ES << 7020", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel1, "ES @ 7020", Alert.BAR, Sound.Chimes);

# LEVEL 2 - 7011 Bonus ğŸ¯
Alert(enableAlerts and close crosses above level2, "ES >> 7011 - BONUS ğŸ¯!", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level2, "ES << 7011", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel2, "ES @ 7011", Alert.BAR, Sound.Chimes);

# LEVEL 3 - 7006 Bonus ğŸ¯
Alert(enableAlerts and close crosses above level3, "ES >> 7006 - BONUS ğŸ¯!", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level3, "ES << 7006", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel3, "ES @ 7006", Alert.BAR, Sound.Chimes);

# LEVEL 4 - 7002 [x]
Alert(enableAlerts and close crosses above level4, "ES >> 7002", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level4, "ES << 7002", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel4, "ES @ 7002", Alert.BAR, Sound.Chimes);

# LEVEL 5 - 6991 Micro Support
Alert(enableAlerts and close crosses above level5, "ES >> 6991", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level5, "ES << 6991 - Micro Sup Lost", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel5, "ES @ 6991 - Micro Support", Alert.BAR, Sound.Chimes);

# LEVEL 6 - 6986 [x]
Alert(enableAlerts and close crosses above level6, "ES >> 6986", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level6, "ES << 6986", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel6, "ES @ 6986", Alert.BAR, Sound.Chimes);

# LEVEL 7 - 6977 [x]
Alert(enableAlerts and close crosses above level7, "ES >> 6977", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level7, "ES << 6977", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel7, "ES @ 6977", Alert.BAR, Sound.Chimes);

# LEVEL 8 - 6964 Failed BD
Alert(enableAlerts and close crosses above level8, "ES >> 6964", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level8, "ES << 6964 - TRAP?", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel8, "ES @ 6964 - Failed BD", Alert.BAR, Sound.Chimes);

# LEVEL 9 - 6953 Support
Alert(enableAlerts and close crosses above level9, "ES >> 6953", Alert.BAR, Sound.Ring);
Alert(enableAlerts and close crosses below level9, "ES << 6953", Alert.BAR, Sound.Bell);
Alert(enableAlerts and atLevel9, "ES @ 6953", Alert.BAR, Sound.Chimes);

# LEVEL 10 - 6945 Key Support
Alert(enableAlerts and level10 > 0 and close crosses above level10, "ES >> 6945 - Reclaim", Alert.BAR, Sound.Ring);
Alert(enableAlerts and level10 > 0 and close crosses below level10, "ES << 6945 - SELL!", Alert.BAR, Sound.Bell);
Alert(enableAlerts and level10 > 0 and atLevel10, "ES @ 6945 - Key Support", Alert.BAR, Sound.Chimes);

# LEVEL 11 - 6935 ğŸ‚ Flag
Alert(enableAlerts and level11 > 0 and close crosses above level11, "ES >> 6935", Alert.BAR, Sound.Ring);
Alert(enableAlerts and level11 > 0 and close crosses below level11, "ES << 6935", Alert.BAR, Sound.Bell);
Alert(enableAlerts and level11 > 0 and atLevel11, "ES @ 6935", Alert.BAR, Sound.Chimes);

# LEVEL 12 - 6925 Major Support
Alert(enableAlerts and level12 > 0 and close crosses above level12, "ES >> 6925", Alert.BAR, Sound.Ring);
Alert(enableAlerts and level12 > 0 and close crosses below level12, "ES << 6925", Alert.BAR, Sound.Bell);
Alert(enableAlerts and level12 > 0 and atLevel12, "ES @ 6925", Alert.BAR, Sound.Chimes);

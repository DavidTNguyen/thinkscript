//@version=6
indicator("Market Internals Dashboard v3 (Pine)", overlay=true, max_labels_count=500)

// === USER INPUTS ===
showLabels = input.bool(true, "Show Labels")
showCompactRow = input.bool(false, "Show Compact Row (Overview + Scores only)")
showUltraRow = input.bool(true, "Show Ultra Row")
showDebugRow = input.bool(false, "Show Debug Row")
tablePosition = input.string("Top Right", "Dashboard Position", options=["Top Center", "Top Right", "Bottom Left", "Bottom Right"])

useDynamicThresholds = input.bool(false, "Use Dynamic Thresholds")
lookbackPeriod = input.int(10, "Trend Lookback", minval=2)

// Symbol inputs (allow user to map to available feeds)
symVIX = input.string("CBOE:VIX", "VIX Ticker")
symTICK = input.string("USI:TICK", "TICK Ticker")
symADD = input.string("USI:ADD", "ADD Ticker")
symTRIN = input.string("USI:TRIN", "TRIN Ticker")
symUVOL = input.string("USI:UVOL", "UVOL Ticker")
symDVOL = input.string("USI:DVOL", "DVOL Ticker")
symNAUH = input.string("", "NH Ticker (optional - leave blank if unavailable)")
symNADL = input.string("", "NL Ticker (optional - leave blank if unavailable)")
symVOLD = input.string("USI:VOLD", "VOLD Ticker")

// Thresholds
vixCalm = input.float(18.0, "VIX Calm")
vixNormal = input.float(25.0, "VIX Normal")
vixElevated = input.float(35.0, "VIX Elevated")

tickBullish = input.int(500, "TICK Bullish")
tickBearish = input.int(-500, "TICK Bearish")
tickExtremeBull = input.int(1000, "TICK Extreme Bull")
tickExtremeBear = input.int(-1000, "TICK Extreme Bear")

addBullish = input.int(500, "ADD Bullish")
addBearish = input.int(-500, "ADD Bearish")
addExtremeBull = input.int(1500, "ADD Extreme Bull")
addExtremeBear = input.int(-1500, "ADD Extreme Bear")

// === DATA FETCH ===
vix = request.security(symVIX, timeframe.period, close)
vixPrev = request.security(symVIX, timeframe.period, close[1])
vixDelta = vix - vixPrev
tick = request.security(symTICK, timeframe.period, close)
add_ = request.security(symADD, timeframe.period, close)
trin = request.security(symTRIN, timeframe.period, close)
uvol = request.security(symUVOL, timeframe.period, close)
dvol = request.security(symDVOL, timeframe.period, close)
nh = symNAUH != "" ? request.security(symNAUH, timeframe.period, close) : na
nl = symNADL != "" ? request.security(symNADL, timeframe.period, close) : na
vold = request.security(symVOLD, timeframe.period, close)

// === DERIVED ===
vixRegime = vix < vixCalm ? 0.8 : vix < vixNormal ? 1.0 : vix < vixElevated ? 1.3 : 1.6
dynTickBull = useDynamicThresholds ? tickBullish * vixRegime : tickBullish
dynTickBear = useDynamicThresholds ? tickBearish * vixRegime : tickBearish
dynAddBull = useDynamicThresholds ? addBullish * vixRegime : addBullish
dynAddBear = useDynamicThresholds ? addBearish * vixRegime : addBearish

totalVol = uvol + dvol
volUpPercentRaw = totalVol > 0 ? (uvol / totalVol) * 100.0 : na
volUpPercent = na(volUpPercentRaw) ? 50.0 : volUpPercentRaw
dynVolBull = useDynamicThresholds ? 62 - (vixRegime * 5) : 60
dynVolBear = useDynamicThresholds ? 38 + (vixRegime * 5) : 40

nhnlRatioRaw = (not na(nl) and nl != 0) ? nh / nl : na
nhnlRatio = na(nhnlRatioRaw) ? na : nhnlRatioRaw

cumTick = ta.cum(tick)
cumTickMA = ta.sma(cumTick, lookbackPeriod)
cumTickTrend = cumTick > cumTickMA ? 1 : cumTick < cumTickMA ? -1 : 0
// Net Bias (scaled declining volume component)
netBias = add_ + (tick / 5.0) + (vold / 1000000.0)

// === SCORES ===
scoreVol = na(volUpPercent) ? 0 : volUpPercent >= dynVolBull ? 1 : volUpPercent >= 55 ? 0.5 : volUpPercent <= dynVolBear ? -1 : volUpPercent <= 45 ? -0.5 : 0
scoreADD = na(add_) ? 0 : add_ >= dynAddBull ? 1 : add_ >= 100 ? 0.5 : add_ <= dynAddBear ? -1 : add_ <= -100 ? -0.5 : 0
scoreTICK = na(tick) ? 0 : tick >= dynTickBull ? 1 : tick >= 300 ? 0.5 : tick <= dynTickBear ? -1 : tick <= -300 ? -0.5 : 0
scoreTRIN = na(trin) ? 0 : trin < 0.7 ? 1 : trin < 0.9 ? 0.5 : trin > 1.3 ? -1 : trin > 1.1 ? -0.5 : 0
scoreNHNL = na(nhnlRatio) ? 0 : nhnlRatio > 10 ? 1 : nhnlRatio > 3 ? 0.5 : nhnlRatio < 0.3 ? -1 : nhnlRatio < 0.5 ? -0.5 : 0
scoreVIX = na(vix) ? 0 : vix < vixCalm and vixDelta < 0 ? 1 : vix < vixNormal ? (vixDelta <= 0 ? 0.5 : 0.25) : vix > vixElevated ? -1 : (vixDelta <= 0 ? 0.25 : -0.25)
scoreCumTick = cumTickTrend > 0 ? 0.5 : cumTickTrend < 0 ? -0.5 : 0

totalScore = scoreVol + scoreADD + scoreTICK + scoreTRIN + scoreNHNL + scoreVIX + scoreCumTick
totalScoreSafe = na(totalScore) ? 0 : totalScore

// === TRENDS ===
addTrend = add_ > ta.sma(add_, lookbackPeriod) ? 1 : add_ < ta.sma(add_, lookbackPeriod) ? -1 : 0
tickTrend = tick > ta.sma(tick, lookbackPeriod) ? 1 : tick < ta.sma(tick, lookbackPeriod) ? -1 : 0
vixTrend = vix < ta.sma(vix, lookbackPeriod) ? 1 : vix > ta.sma(vix, lookbackPeriod) ? -1 : 0
trinTrend = trin < ta.sma(trin, lookbackPeriod) ? 1 : trin > ta.sma(trin, lookbackPeriod) ? -1 : 0

safeAddTrend = na(addTrend) ? 0 : addTrend
safeTickTrend = na(tickTrend) ? 0 : tickTrend
safeVixTrend = na(vixTrend) ? 0 : vixTrend
safeTrinTrend = na(trinTrend) ? 0 : trinTrend
safeCumTickTrend = na(cumTickTrend) ? 0 : cumTickTrend
overallTrend = safeAddTrend + safeTickTrend + safeVixTrend + safeTrinTrend + safeCumTickTrend

// === EXTREMES ===
tickExtreme = tick >= tickExtremeBull ? 2 : tick <= tickExtremeBear ? -2 : 0
addExtreme = add_ >= addExtremeBull ? 2 : add_ <= addExtremeBear ? -2 : 0
vixExtreme = vix >= vixElevated ? -2 : vix <= vixCalm ? 1 : 0
trinExtreme = trin < 0.5 ? 2 : trin > 2.0 ? -2 : 0

// === SCENARIO, STRENGTH, CONFIDENCE ===
scenario = totalScoreSafe >= 3 ? 3 : totalScoreSafe >= 1.5 ? 2 : totalScoreSafe >= 0.5 ? 1 : totalScoreSafe <= -3 ? -3 : totalScoreSafe <= -1.5 ? -2 : totalScoreSafe <= -0.5 ? -1 : 0
strengthScore = math.round(50 + (totalScoreSafe * 7))
confidence = math.abs(totalScoreSafe) >= 4 ? 95 : math.abs(totalScoreSafe) >= 3 ? 85 : math.abs(totalScoreSafe) >= 2 ? 70 : math.abs(totalScoreSafe) >= 1 ? 55 : 30

// === Availability Flags ===
hasVol = not na(totalVol) and totalVol != 0
hasAdd = not na(add_)
hasTick = not na(tick)
hasTrin = not na(trin)
hasNHNL = not na(nhnlRatio)
hasVIX = not na(vix)
hasCumT = not na(cumTickTrend)

// === Helper Functions for Color Mapping ===
f_scoreColor(float score) => score >= 1 ? color.new(#00FF00, 0) : score >= 0.5 ? color.new(#00CC00, 0) : score <= -1 ? color.new(#FF0000, 0) : score <= -0.5 ? color.new(#FF6600, 0) : color.new(color.gray, 70)
f_biasColor(float b) => b >= 5 ? color.new(#00FF00, 0) : b >= 2 ? color.new(#00CC00, 0) : b <= -5 ? color.new(#FF0000, 0) : b <= -2 ? color.new(#FF6600, 0) : color.new(color.gray, 70)

// === Render Labels ===
var label lblOverview = na
var label lblTrend = na
var label lblMetrics = na
var label lblScores = na
var label lblCompact = na
var label lblUltra = na
var table internalsTbl = na

// Helper: scenario text (use if/else to avoid multi-line ternary parsing issues)
f_scenarioText(int sc) =>
    string res = "NEUTRAL"
    if sc == 3
        res := "STRONG BULLISH"
    else if sc == 2
        res := "BULLISH"
    else if sc == 1
        res := "lean bull"
    else if sc == -1
        res := "lean bear"
    else if sc == -2
        res := "BEARISH"
    else if sc == -3
        res := "STRONG BEARISH"
    res
scenarioText = f_scenarioText(scenario)

// Helper: scenario emoji text for compact label
f_scenarioEmoji(int sc) =>
    string e = "NEUTRAL"
    if sc == 3
        e := "STRONG ðŸ‚"
    else if sc == 2
        e := "ðŸ‚"
    else if sc == 1
        e := "lean ðŸ‚"
    else if sc == -1
        e := "lean ðŸ»"
    else if sc == -2
        e := "ðŸ»"
    else if sc == -3
        e := "STRONG ðŸ»"
    e

// Helper: sign char for trend
f_sign(int t) => t > 0 ? "+" : t < 0 ? "-" : "="

// Helper: delta sign for floats ("+"/"-"/"")
f_deltaSign(float d) => d > 0 ? "+" : d < 0 ? "-" : ""

// Helper: score text color by sign (top-level declaration)
f_scoreTextColor(float s) => s > 0 ? color.new(#00FF00, 0) : s < 0 ? color.new(#FF5555, 0) : color.new(color.gray, 0)

// Helper: convert table position string to position constant
f_tablePosition(string pos) =>
    string result = position.top_right
    if pos == "Top Center"
        result := position.top_center
    else if pos == "Top Right"
        result := position.top_right
    else if pos == "Bottom Left"
        result := position.bottom_left
    else if pos == "Bottom Right"
        result := position.bottom_right
    result

// Clear old labels on each bar
if barstate.islast
    // Initialize table once
    if na(internalsTbl)
        internalsTbl := table.new(f_tablePosition(tablePosition), 12, 7, border_width=2)
    
    // Update table on every bar
    // Row 0 header labels
        table.cell(internalsTbl, 0, 0, "SECTION", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 0, "VALUE", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 2, 0, "EXTRA", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 3, 0, "VOL", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 4, 0, "BREADTH", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 5, 0, "TICK", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 6, 0, "TRIN", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 7, 0, "VIX", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 8, 0, "NHNL", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 9, 0, "NHNL Sc", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    
    // Update table on every bar
    // Row 0 header labels
    table.cell(internalsTbl, 0, 0, "SECTION", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 1, 0, "VALUE", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 2, 0, "EXTRA", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 3, 0, "VOL", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 4, 0, "BREADTH", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 5, 0, "TICK", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 6, 0, "TRIN", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 7, 0, "VIX", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 8, 0, "NHNL", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl, 9, 0, "NHNL Sc", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl,10, 0, "Bias", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)
    table.cell(internalsTbl,11, 0, "CumTick", bgcolor=color.new(#1E1E1E, 0), text_color=color.white, text_size=size.normal)

    // Compact mode: single row with Overview + Scores
    if showCompactRow
        // Scenario color
        scenarioColor = color.new(#FFFF00, 0)
        if scenario >= 2
            scenarioColor := color.new(#00FF00, 0)
        else if scenario <= -2
            scenarioColor := color.new(#FF0000, 0)
        else if scenario == 1
            scenarioColor := color.new(#90EE90, 0)
        else if scenario == -1
            scenarioColor := color.new(#FFB6C1, 0)
        
        // Build compact string
        compactStr = scenarioText + " | S:" + str.tostring(math.round(totalScoreSafe*10)/10.0) + " Str:" + str.tostring(strengthScore) + " Conf:" + str.tostring(confidence) + "%"
        
        table.cell(internalsTbl, 0, 1, "Compact", bgcolor=color.new(#2E2E2E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 1, compactStr, bgcolor=scenarioColor, text_color=color.black, text_size=size.normal)
        table.cell(internalsTbl, 2, 1, "Vol:" + str.tostring(math.round(scoreVol*10)/10.0), bgcolor=f_scoreColor(scoreVol), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 3, 1, "ADD:" + str.tostring(math.round(scoreADD*10)/10.0), bgcolor=f_scoreColor(scoreADD), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 4, 1, "TICK:" + str.tostring(math.round(scoreTICK*10)/10.0), bgcolor=f_scoreColor(scoreTICK), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 5, 1, "TRIN:" + str.tostring(math.round(scoreTRIN*10)/10.0), bgcolor=f_scoreColor(scoreTRIN), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 6, 1, "VIX:" + str.tostring(math.round(scoreVIX*10)/10.0), bgcolor=f_scoreColor(scoreVIX), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 7, 1, "NH/NL:" + str.tostring(math.round(scoreNHNL*10)/10.0), bgcolor=f_scoreColor(scoreNHNL), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 8, 1, "CumT:" + str.tostring(math.round(scoreCumTick*10)/10.0), bgcolor=f_scoreColor(scoreCumTick), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 9, 1, "", bgcolor=color.new(#1A1A1A, 0))
        table.cell(internalsTbl,10, 1, "", bgcolor=color.new(#1A1A1A, 0))
        table.cell(internalsTbl,11, 1, "", bgcolor=color.new(#1A1A1A, 0))

    // Scenario color (reduced nesting)
    if not showCompactRow
        scenarioColor = color.new(#FFFF00, 0)
        if scenario >= 2
            scenarioColor := color.new(#00FF00, 0)
        else if scenario <= -2
            scenarioColor := color.new(#FF0000, 0)
        else if scenario == 1
            scenarioColor := color.new(#90EE90, 0)
        else if scenario == -1
            scenarioColor := color.new(#FFB6C1, 0)

        // Row 1: Overview
        table.cell(internalsTbl, 0, 1, "Overview", bgcolor=color.new(#2E2E2E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 1, scenarioText, bgcolor=scenarioColor, text_color=color.black, text_size=size.large)
        table.cell(internalsTbl, 2, 1, "Str:" + str.tostring(strengthScore) + " Conf:" + str.tostring(confidence) + "%", bgcolor=color.new(#2E2E2E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 3, 1, hasVol ? str.tostring(math.round(volUpPercent*10)/10.0) + "%" : "-", bgcolor=f_scoreColor(scoreVol), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 4, 1, hasAdd ? str.tostring(math.round(add_)) : "-", bgcolor=f_scoreColor(scoreADD), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 5, 1, hasTick ? str.tostring(math.round(tick)) : "-", bgcolor=f_scoreColor(scoreTICK), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 6, 1, hasTrin ? str.tostring(trin, format.mintick) : "-", bgcolor=f_scoreColor(scoreTRIN), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 7, 1, hasVIX ? str.tostring(vix, format.mintick) : "-", bgcolor=f_scoreColor(scoreVIX), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 8, 1, hasNHNL ? str.tostring(math.round(nhnlRatio*10)/10.0) + "x" : "-", bgcolor=f_scoreColor(scoreNHNL), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 9, 1, hasNHNL ? str.tostring(math.round(scoreNHNL*10)/10.0) : "-", bgcolor=f_scoreColor(scoreNHNL), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl,10, 1, str.tostring(math.round(netBias*10)/10.0), bgcolor=f_biasColor(netBias), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl,11, 1, str.tostring(math.round(cumTick*10)/10.0), bgcolor=f_scoreColor(scoreCumTick), text_color=color.white, text_size=size.normal)

        // Row 2: Scores breakdown
        table.cell(internalsTbl, 0, 2, "Scores", bgcolor=color.new(#2E2E2E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 2, "Total:" + str.tostring(math.round(totalScoreSafe*10)/10.0), bgcolor=f_scoreColor(totalScoreSafe), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 2, 2, "CumTick:" + (hasCumT ? str.tostring(scoreCumTick) : "-"), bgcolor=f_scoreColor(scoreCumTick), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 3, 2, str.tostring(math.round(scoreVol*10)/10.0), bgcolor=f_scoreColor(scoreVol), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 4, 2, str.tostring(math.round(scoreADD*10)/10.0), bgcolor=f_scoreColor(scoreADD), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 5, 2, str.tostring(math.round(scoreTICK*10)/10.0), bgcolor=f_scoreColor(scoreTICK), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 6, 2, str.tostring(math.round(scoreTRIN*10)/10.0), bgcolor=f_scoreColor(scoreTRIN), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 7, 2, str.tostring(math.round(scoreVIX*10)/10.0), bgcolor=f_scoreColor(scoreVIX), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 8, 2, str.tostring(math.round(scoreNHNL*10)/10.0), bgcolor=f_scoreColor(scoreNHNL), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 9, 2, str.tostring(math.round(netBias*10)/10.0), bgcolor=f_biasColor(netBias), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl,10, 2, str.tostring(math.round(cumTick*10)/10.0), bgcolor=f_scoreColor(scoreCumTick), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl,11, 2, "", bgcolor=color.new(#1A1A1A, 0))

        // Row 3: Trend components
        table.cell(internalsTbl, 0, 3, "Trend", bgcolor=color.new(#2E2E2E, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 3, "Sum:" + str.tostring(overallTrend), bgcolor=color.new(#404040, 0), text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 2, 3, "ADD:" + (hasAdd ? f_sign(addTrend) : "-"), bgcolor=color.new(#383838, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 3, 3, "TICK:" + (hasTick ? f_sign(tickTrend) : "-"), bgcolor=color.new(#383838, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 4, 3, "TRIN:" + (hasTrin ? f_sign(trinTrend) : "-"), bgcolor=color.new(#383838, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 5, 3, "VIX:" + (hasVIX ? f_sign(vixTrend) : "-"), bgcolor=color.new(#383838, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 6, 3, "CUMT:" + (hasCumT ? f_sign(cumTickTrend) : "-"), bgcolor=color.new(#383838, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 7, 3, "NHNL:" + (hasNHNL?"val":"-"), bgcolor=color.new(#2A2A2A, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 8, 3, "NHNL Sc:" + (hasNHNL?str.tostring(scoreNHNL):"-"), bgcolor=color.new(#2A2A2A, 0), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl, 9, 3, "Bias:" + str.tostring(math.round(netBias)), bgcolor=f_biasColor(netBias), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl,10, 3, "CumTick:" + str.tostring(math.round(cumTick)), bgcolor=f_scoreColor(scoreCumTick), text_color=color.white, text_size=size.small)
        table.cell(internalsTbl,11, 3, "", bgcolor=color.new(#1A1A1A, 0))

        // Row 4: Extremes (reduced nesting)
        table.cell(internalsTbl, 0, 4, "Extremes", bgcolor=color.new(#2E2E2E, 0), text_color=color.white, text_size=size.normal)
        // TICK extreme
        tickText = tickExtreme != 0 ? "TICK!" : ""
        tickBg = tickExtreme != 0 ? color.new(#FF8C00, 0) : color.new(#1A1A1A, 0)
        tickFg = tickExtreme != 0 ? color.white : color.gray
        table.cell(internalsTbl, 1, 4, tickText, bgcolor=tickBg, text_color=tickFg, text_size=size.normal)
        // ADD extreme
        addText = addExtreme != 0 ? "ADD!" : ""
        addBg = addExtreme != 0 ? color.new(#FF8C00, 0) : color.new(#1A1A1A, 0)
        addFg = addExtreme != 0 ? color.white : color.gray
        table.cell(internalsTbl, 2, 4, addText, bgcolor=addBg, text_color=addFg, text_size=size.normal)
        // TRIN extreme
        trinText = trinExtreme != 0 ? "TRIN!" : ""
        trinBg = trinExtreme != 0 ? color.new(#FF8C00, 0) : color.new(#1A1A1A, 0)
        trinFg = trinExtreme != 0 ? color.white : color.gray
        table.cell(internalsTbl, 3, 4, trinText, bgcolor=trinBg, text_color=trinFg, text_size=size.normal)
        // VIX extreme
        vixText = vixExtreme != 0 ? "VIX!" : ""
        vixBg = vixExtreme != 0 ? color.new(#FF8C00, 0) : color.new(#1A1A1A, 0)
        vixFg = vixExtreme != 0 ? color.white : color.gray
        table.cell(internalsTbl, 4, 4, vixText, bgcolor=vixBg, text_color=vixFg, text_size=size.normal)
        table.cell(internalsTbl, 5, 4, "", bgcolor=color.new(color.gray,95))
        table.cell(internalsTbl, 6, 4, "", bgcolor=color.new(color.gray,95))
        table.cell(internalsTbl, 7, 4, "", bgcolor=color.new(color.gray,95))
        table.cell(internalsTbl, 8, 4, "", bgcolor=color.new(color.gray,95))
        table.cell(internalsTbl, 9, 4, "", bgcolor=color.new(color.gray,95))
        table.cell(internalsTbl,10, 4, "", bgcolor=color.new(color.gray,95))
        table.cell(internalsTbl,11, 4, "", bgcolor=color.new(color.gray,95))

    // Row 5: Ultra compact (table visibility controlled by input)
    if showUltraRow and not showCompactRow
        // Reduce nesting: build code string via simple if/else
        code = "N"
        if scenario == 3
            code := "SB"
        else if scenario == 2
            code := "B"
        else if scenario == 1
            code := "b"
        else if scenario == -1
            code := "b-"
        else if scenario == -2
            code := "Be"
        else if scenario == -3
            code := "SB-"
        // Assemble ultra compact string with minimal ternaries
        uc = code + " S:" + str.tostring(math.round(totalScoreSafe*10)/10.0)
        uc += (hasVol ? " V%:" + str.tostring(math.round(volUpPercent)) : " V%:-")
        uc += (hasAdd ? " A:" + str.tostring(math.round(add_)) : " A:-")
        uc += (hasTick ? " T:" + str.tostring(math.round(tick)) : " T:-")
        uc += (hasTrin ? " Tr:" + str.tostring(trin, format.mintick) : " Tr:-")
        uc += (hasVIX ? " VX:" + str.tostring(vix, format.mintick) : " VX:-")
        // Color code based on overall trend
        ultraBg = color.new(#2E2E2E, 0)
        if overallTrend >= 3
            ultraBg := color.new(#00AA00, 0)  // Strong green for strong up trend
        else if overallTrend >= 1
            ultraBg := color.new(#006600, 0)  // Dark green for up trend
        else if overallTrend <= -3
            ultraBg := color.new(#AA0000, 0)  // Strong red for strong down trend
        else if overallTrend <= -1
            ultraBg := color.new(#660000, 0)  // Dark red for down trend
        table.cell(internalsTbl, 0, 5, "Ultra", bgcolor=ultraBg, text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 5, uc, bgcolor=ultraBg, text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 2, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 3, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 4, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 5, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 6, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 7, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 8, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl, 9, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl,10, 5, "", bgcolor=ultraBg)
        table.cell(internalsTbl,11, 5, "", bgcolor=ultraBg)

    // Row 6: Debug breakdown (higher contrast, larger text)
    if showDebugRow and not showCompactRow
        darkBg = color.new(#1E1E1E, 0)
        table.cell(internalsTbl, 0, 6, "DEBUG", bgcolor=darkBg, text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl, 1, 6, "Tot:" + str.tostring(math.round(totalScoreSafe*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(totalScoreSafe), text_size=size.normal)
        table.cell(internalsTbl, 2, 6, "VOL:" + str.tostring(math.round(scoreVol*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreVol), text_size=size.normal)
        table.cell(internalsTbl, 3, 6, "ADD:" + str.tostring(math.round(scoreADD*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreADD), text_size=size.normal)
        table.cell(internalsTbl, 4, 6, "TICK:" + str.tostring(math.round(scoreTICK*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreTICK), text_size=size.normal)
        table.cell(internalsTbl, 5, 6, "TRIN:" + str.tostring(math.round(scoreTRIN*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreTRIN), text_size=size.normal)
        table.cell(internalsTbl, 6, 6, "NHNL:" + str.tostring(math.round(scoreNHNL*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreNHNL), text_size=size.normal)
        table.cell(internalsTbl, 7, 6, "VIX:" + str.tostring(math.round(scoreVIX*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreVIX), text_size=size.normal)
        table.cell(internalsTbl, 8, 6, "CUMT:" + str.tostring(math.round(scoreCumTick*100)/100.0), bgcolor=darkBg, text_color=f_scoreTextColor(scoreCumTick), text_size=size.normal)
        table.cell(internalsTbl, 9, 6, "Scenario:" + str.tostring(scenario), bgcolor=darkBg, text_color=color.white, text_size=size.normal)
        table.cell(internalsTbl,10, 6, "", bgcolor=darkBg)
        table.cell(internalsTbl,11, 6, "", bgcolor=darkBg)

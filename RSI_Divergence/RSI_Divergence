# RSI Divergence Indicator #TSBuild25
# Identifies Regular and Hidden Bullish/Bearish Divergences
# Plots lines and labels on price and RSI, with color coding

input rsiLength = 14;
input price = close;
input overBought = 70;
input overSold = 30;
input lookback = 20; # How many bars to look back for pivots

# --- RSI Calculation ---
def rsi = RSI(price, rsiLength);

# --- Find Pivots (Highs/Lows) ---
def pivotHigh = high == Highest(high, lookback);
def pivotLow = low == Lowest(low, lookback);
def rsiPivotHigh = rsi == Highest(rsi, lookback);
def rsiPivotLow = rsi == Lowest(rsi, lookback);

def pricePivotBar = if pivotHigh or pivotLow then BarNumber() else Double.NaN;
def rsiPivotBar = if rsiPivotHigh or rsiPivotLow then BarNumber() else Double.NaN;

def lastPricePivotBar = if !IsNaN(pricePivotBar) then pricePivotBar else lastPricePivotBar[1];
def lastRSIPivotBar = if !IsNaN(rsiPivotBar) then rsiPivotBar else lastRSIPivotBar[1];

def lastPricePivot = if !IsNaN(pricePivotBar) then if pivotHigh then high else low else lastPricePivot[1];
def lastRSIPivot = if !IsNaN(rsiPivotBar) then rsi else lastRSIPivot[1];

# --- Detect Divergences ---
# Regular Bullish: Price lower low, RSI higher low
# Regular Bearish: Price higher high, RSI lower high
# Hidden Bullish: Price higher low, RSI lower low
# Hidden Bearish: Price lower high, RSI higher high

def regBull = pivotLow and lastPricePivot < low and rsi > lastRSIPivot;
def regBear = pivotHigh and lastPricePivot > high and rsi < lastRSIPivot;
def hidBull = pivotLow and lastPricePivot > low and rsi < lastRSIPivot;
def hidBear = pivotHigh and lastPricePivot < high and rsi > lastRSIPivot;

# --- Draw Divergence Lines on Price ---
AddChartLine(regBull, lastPricePivotBar, lastPricePivot, BarNumber(), low, Color.GREEN, Curve.SHORT_DASH);
AddChartLine(regBear, lastPricePivotBar, lastPricePivot, BarNumber(), high, Color.RED, Curve.SHORT_DASH);
AddChartLine(hidBull, lastPricePivotBar, lastPricePivot, BarNumber(), low, Color.DARK_GREEN, Curve.SHORT_DASH);
AddChartLine(hidBear, lastPricePivotBar, lastPricePivot, BarNumber(), high, Color.DARK_RED, Curve.SHORT_DASH);

# --- Draw Divergence Lines on RSI ---
AddChartLine(regBull, lastRSIPivotBar, lastRSIPivot, BarNumber(), rsi, Color.GREEN, Curve.SHORT_DASH, "RSI");
AddChartLine(regBear, lastRSIPivotBar, lastRSIPivot, BarNumber(), rsi, Color.RED, Curve.SHORT_DASH, "RSI");
AddChartLine(hidBull, lastRSIPivotBar, lastRSIPivot, BarNumber(), rsi, Color.DARK_GREEN, Curve.SHORT_DASH, "RSI");
AddChartLine(hidBear, lastRSIPivotBar, lastRSIPivot, BarNumber(), rsi, Color.DARK_RED, Curve.SHORT_DASH, "RSI");

# --- Divergence Labels ---
AddChartBubble(regBull, low, "Reg Bullish", Color.GREEN, no);
AddChartBubble(regBear, high, "Reg Bearish", Color.RED, yes);
AddChartBubble(hidBull, low, "Hidden Bullish", Color.DARK_GREEN, no);
AddChartBubble(hidBear, high, "Hidden Bearish", Color.DARK_RED, yes);

# --- Alerts ---
Alert(regBull or hidBull, "RSI Bullish Divergence!", Alert.BAR, Sound.Bell);
Alert(regBear or hidBear, "RSI Bearish Divergence!", Alert.BAR, Sound.Bell);

# --- RSI Plot (for reference) ---
plot RSIline = rsi;
RSIline.SetDefaultColor(Color.GRAY);
RSIline.SetLineWeight(1);
RSIline.HideTitle();
RSIline.HideBubble();

plot OverBoughtLine = overBought;
OverBoughtLine.SetDefaultColor(Color.LIGHT_RED);
OverBoughtLine.SetStyle(Curve.SHORT_DASH);
OverBoughtLine.HideTitle();
OverBoughtLine.HideBubble();

plot OverSoldLine = overSold;
OverSoldLine.SetDefaultColor(Color.LIGHT_GREEN);
OverSoldLine.SetStyle(Curve.SHORT_DASH);
OverSoldLine.HideTitle();
OverSoldLine.HideBubble();

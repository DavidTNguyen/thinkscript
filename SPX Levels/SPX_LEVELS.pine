//@version=5
indicator("SPX Levels: Trading Playbook", overlay=true, max_lines_count=500, max_labels_count=500)

// === SPX Trading Playbook - Levels & Scenarios ===
// Updated: November 20, 2025
// 
// KEY TRADING SCENARIOS:
//
// 1. BIG GAP DOWN + FAST TOUCH 6549 ¬± 5
//    - Look for stop-in bets and oversold bounce
//    - Entry: Long after reversal confirmation
//    - Target: First upside level = 6640
//
// 2. SLOW DRIFT LOWER (No 6549 break)
//    - Market stays bearish
//    - Strategy: Short rallies toward fail area (6640)
//
// 3. BREAK ABOVE 6640 ‚Üí 6670 ‚Üí 6760
//    - Watch volume: Needs sustained push for short covering
//    - Entry: Long after 6640 holds as support
//    - Target: 6760-6770, then 6880

// === INPUTS ===
// Resistance Levels
level1 = input.float(6880, "R5 - Major resistance / Open path target", group="üî¥ Resistance Levels")
level1_thickness = input.int(5, "R5 Line Thickness", minval=1, maxval=10, group="üî¥ Resistance Levels")
level2 = input.float(6770, "R4 - Squeeze setup zone HIGH", group="üî¥ Resistance Levels")
level2_thickness = input.int(4, "R4 Line Thickness", minval=1, maxval=10, group="üî¥ Resistance Levels")
level3 = input.float(6760, "R3 - Squeeze setup zone LOW / Major target", group="üî¥ Resistance Levels")
level3_thickness = input.int(4, "R3 Line Thickness", minval=1, maxval=10, group="üî¥ Resistance Levels")
level4 = input.float(6670, "R2 - Stop zone / Short-cover clusters", group="üî¥ Resistance Levels")
level4_thickness = input.int(3, "R2 Line Thickness", minval=1, maxval=10, group="üî¥ Resistance Levels")
level5 = input.float(6640, "R1 - FAIL AREA (Needs volume to clear)", group="üî¥ Resistance Levels")
level5_thickness = input.int(5, "R1 Line Thickness", minval=1, maxval=10, group="üî¥ Resistance Levels")

// Support Levels
level6 = input.float(6549, "KEY BULLISH TRIGGER (¬± 5)", group="üü¢ Support Levels")
level6_thickness = input.int(5, "KEY Line Thickness", minval=1, maxval=10, group="üü¢ Support Levels")
level7 = input.float(6513, "S1 - Next support / Oversold reversal zone (¬± 5)", group="üü¢ Support Levels")
level7_thickness = input.int(4, "S1 Line Thickness", minval=1, maxval=10, group="üü¢ Support Levels")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="üîî Alert Settings")
alertSensitivity = input.float(5.0, "Alert Sensitivity", minval=0.1, maxval=10.0, group="üîî Alert Settings")

// Label Visibility
showLabels = input.bool(true, "Show Labels", group="üìä Display Settings")
showLines = input.bool(true, "Show Level Lines", group="üìä Display Settings")

// === LEVEL LINES ===
var line l1 = na
var line l2 = na
var line l3 = na
var line l4 = na
var line l5 = na
var line l6 = na
var line l7 = na

if showLines and barstate.islast
    // R5 - 6880 (Cyan)
    l1 := line.new(bar_index - 100, level1, bar_index + 20, level1, color=color.aqua, width=level1_thickness, style=line.style_solid)
    
    // R4 - 6770 (Light Green)
    l2 := line.new(bar_index - 100, level2, bar_index + 20, level2, color=color.lime, width=level2_thickness, style=line.style_solid)
    
    // R3 - 6760 (Light Green)
    l3 := line.new(bar_index - 100, level3, bar_index + 20, level3, color=color.lime, width=level3_thickness, style=line.style_solid)
    
    // R2 - 6670 (Orange)
    l4 := line.new(bar_index - 100, level4, bar_index + 20, level4, color=color.orange, width=level4_thickness, style=line.style_solid)
    
    // R1 - 6640 FAIL AREA (Red, Heavy)
    l5 := line.new(bar_index - 100, level5, bar_index + 20, level5, color=color.red, width=level5_thickness, style=line.style_solid)
    
    // KEY - 6549 TRIGGER (Green, Heavy)
    l6 := line.new(bar_index - 100, level6, bar_index + 20, level6, color=color.green, width=level6_thickness, style=line.style_solid)
    
    // S1 - 6513 Oversold (Dark Green)
    l7 := line.new(bar_index - 100, level7, bar_index + 20, level7, color=color.new(color.green, 30), width=level7_thickness, style=line.style_solid)

// === LABELS ===
if barstate.islast and showLabels
    label.new(bar_index, level1, "R5: 6880 - Open path", style=label.style_label_left, color=color.aqua, textcolor=color.white)
    label.new(bar_index, level2, "R4: 6770 - Squeeze HIGH", style=label.style_label_left, color=color.lime, textcolor=color.black)
    label.new(bar_index, level3, "R3: 6760 - Squeeze LOW", style=label.style_label_left, color=color.lime, textcolor=color.black)
    label.new(bar_index, level4, "R2: 6670 - Stop zone", style=label.style_label_left, color=color.orange, textcolor=color.white)
    label.new(bar_index, level5, "R1: 6640 - FAIL AREA", style=label.style_label_left, color=color.red, textcolor=color.white)
    label.new(bar_index, level6, "KEY: 6549 - TRIGGER", style=label.style_label_right, color=color.green, textcolor=color.white)
    label.new(bar_index, level7, "S1: 6513 - Oversold", style=label.style_label_right, color=color.new(color.green, 30), textcolor=color.white)

// === POSITION DETECTION ===
above6880 = close > level1
above6770 = close > level2
in6760_6770 = close >= level3 and close <= level2
above6670 = close > level4
above6640 = close > level5
at6640 = close >= level5 - 5 and close <= level5 + 5
below6640 = close < level5
inNeutral = close >= level7 and close < level5
at6549 = close >= level6 - alertSensitivity and close <= level6 + alertSensitivity
below6549 = close < level6
above6513 = close >= level7
at6513 = close >= level7 - alertSensitivity and close <= level7 + alertSensitivity

// Volume spike detection
volSpike = volume > ta.sma(volume, 20) * 1.5

// === ALERT CONDITIONS ===

// UPSIDE PATH ALERTS
alertcondition(ta.crossover(close, level5), "6640 FAIL AREA BROKEN", "SPX ‚òùÔ∏è 6640 - FAIL AREA BROKEN! Watch 6670!")
alertcondition(ta.crossunder(close, level5), "6640 Back in FAIL AREA", "SPX üëá 6640 - Back in FAIL AREA! Short rallies!")
alertcondition(at6640, "At 6640 FAIL AREA", "SPX at 6640 FAIL AREA - Need volume to clear!")

alertcondition(ta.crossover(close, level4), "6670 SHORT-COVER ZONE", "SPX ‚òùÔ∏è 6670 - SHORT-COVER ZONE! Watch 6760-6770!")
alertcondition(ta.crossover(close, level3), "6760 SQUEEZE SETUP", "SPX ‚òùÔ∏è 6760 - SQUEEZE SETUP! Watch 6770, then 6880!")
alertcondition(in6760_6770, "In 6760-6770 SQUEEZE", "SPX in 6760-6770 SQUEEZE ZONE!")

alertcondition(ta.crossover(close, level2), "6770 SQUEEZE", "SPX ‚òùÔ∏è 6770 - SQUEEZE! Open path to 6880!")
alertcondition(ta.crossover(close, level1), "6880 RESISTANCE CLEARED", "SPX ‚òùÔ∏è 6880 - MAJOR RESISTANCE CLEARED!")

// BULLISH TRIGGER ALERTS (6549)
alertcondition(ta.crossunder(close, level6), "6549 KEY TRIGGER", "SPX üëá 6549 - KEY TRIGGER! Watch reversal!")
alertcondition(ta.crossover(close, level6), "6549 Bounce", "SPX ‚òùÔ∏è 6549 - Bounce! Watch 6640!")
alertcondition(at6549, "At 6549 TRIGGER ZONE", "SPX at 6549 ¬± 5 - TRIGGER ZONE! Stops/oversold!")

// OVERSOLD ZONE ALERTS (6513)
alertcondition(ta.crossunder(close, level7), "6513 OVERSOLD", "SPX üëá 6513 - OVERSOLD! Reversal zone!")
alertcondition(ta.crossover(close, level7), "6513 Bounce", "SPX ‚òùÔ∏è 6513 - Bounce! Watch 6549!")
alertcondition(at6513, "At 6513 OVERSOLD ZONE", "SPX at 6513 ¬± 5 - OVERSOLD REVERSAL ZONE!")

// Volume-based alerts
alertcondition(ta.crossover(close, level5) and volSpike, "6640 STRONG VOLUME", "SPX ‚òùÔ∏è 6640 STRONG VOLUME - Short covering!")

// === STATUS TABLE ===
var table statusTable = table.new(position.top_right, 2, 15, border_width=1)

if barstate.islast and showLabels
    // Header
    table.cell(statusTable, 0, 0, "SPX PLAYBOOK", bgcolor=color.new(color.blue, 70), text_color=color.white)
    table.cell(statusTable, 1, 0, str.tostring(close, "#.##"), bgcolor=color.new(color.blue, 70), text_color=color.white)
    
    // Alert Status
    table.cell(statusTable, 0, 1, "Alerts", text_color=color.white)
    table.cell(statusTable, 1, 1, enableAlerts ? "ON" : "OFF", bgcolor=enableAlerts ? color.green : color.red, text_color=color.white)
    
    // Trading Scenario
    scenario = volSpike and at6549 ? "üî• SCENARIO 1: Fast touch!" : below6640 and not at6549 ? "üìâ SCENARIO 2: Slow drift" : above6640 ? "üìà SCENARIO 3: Bull path" : "Neutral"
    scenarioColor = volSpike and at6549 ? color.green : below6640 and not at6549 ? color.red : above6640 ? color.green : color.gray
    table.cell(statusTable, 0, 2, "Scenario", text_color=color.white)
    table.cell(statusTable, 1, 2, scenario, bgcolor=color.new(scenarioColor, 70), text_color=color.white)
    
    // Position Status
    position = above6770 ? "‚òùÔ∏è Open path to 6880!" : in6760_6770 ? "SQUEEZE ZONE 6760-6770" : above6670 and close < level3 ? "Target 6760-6770" : above6640 and close < level4 ? "Watch 6670 stops" : at6640 ? "‚ö†Ô∏è 6640 FAIL" : inNeutral ? "NEUTRAL ZONE" : at6549 ? "üîë 6549 TRIGGER!" : "Below 6549"
    posColor = above6770 ? color.aqua : in6760_6770 ? color.lime : above6670 ? color.orange : above6640 ? color.yellow : at6640 ? color.red : inNeutral ? color.gray : color.green
    table.cell(statusTable, 0, 3, "Position", text_color=color.white)
    table.cell(statusTable, 1, 3, position, bgcolor=color.new(posColor, 70), text_color=color.white)
    
    // Strategy
    strategy = below6640 and close > level6 ? "Short rallies to 6640" : above6640 and close < level3 ? "Long 6640 support ‚Üí 6760-6770" : at6549 ? "Gap down + fast touch = Long!" : "Wait for setup"
    table.cell(statusTable, 0, 4, "Strategy", text_color=color.white)
    table.cell(statusTable, 1, 4, strategy, bgcolor=color.new(color.blue, 80), text_color=color.white)
    
    // Key Levels Summary
    table.cell(statusTable, 0, 5, "FAIL: 6640", text_color=color.white)
    table.cell(statusTable, 1, 5, "TRIGGER: 6549", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 6, "OVERSOLD: 6513", text_color=color.white)
    table.cell(statusTable, 1, 6, "TARGET: 6760-6770", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    // Distance to key levels
    distTo6640 = level5 - close
    distTo6640Str = distTo6640 > 0 ? "-" + str.tostring(math.abs(distTo6640), "#.#") : "+" + str.tostring(math.abs(distTo6640), "#.#")
    table.cell(statusTable, 0, 7, "To 6640 FAIL", text_color=color.white)
    table.cell(statusTable, 1, 7, distTo6640Str, bgcolor=color.new(color.red, 80), text_color=color.white)
    
    distTo6549 = level6 - close
    distTo6549Str = distTo6549 > 0 ? "-" + str.tostring(math.abs(distTo6549), "#.#") : "+" + str.tostring(math.abs(distTo6549), "#.#")
    table.cell(statusTable, 0, 8, "To 6549 TRIGGER", text_color=color.white)
    table.cell(statusTable, 1, 8, distTo6549Str, bgcolor=color.new(color.green, 80), text_color=color.white)
    
    // Volume Status
    volStatus = volSpike ? "üî• SPIKE" : "Normal"
    volColor = volSpike ? color.orange : color.gray
    table.cell(statusTable, 0, 9, "Volume", text_color=color.white)
    table.cell(statusTable, 1, 9, volStatus, bgcolor=color.new(volColor, 70), text_color=color.white)

// === PLOT INVISIBLE LINES FOR ALERT TRIGGERS ===
plot(level1, "R5: 6880", color=color.new(color.aqua, 100))
plot(level2, "R4: 6770", color=color.new(color.lime, 100))
plot(level3, "R3: 6760", color=color.new(color.lime, 100))
plot(level4, "R2: 6670", color=color.new(color.orange, 100))
plot(level5, "R1: 6640 FAIL", color=color.new(color.red, 100))
plot(level6, "KEY: 6549", color=color.new(color.green, 100))
plot(level7, "S1: 6513", color=color.new(color.green, 100))

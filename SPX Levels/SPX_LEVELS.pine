//@version=6
indicator("SPX DEC 1 HEATMAP", overlay=true, max_lines_count=500, max_labels_count=500)

// === SPX DEC 1 HEATMAP - Updated 11/28/2025 ===
// 
// MARKET STRUCTURE (Gamma Positioning):
// HIGH RESISTANCE / SHORT ZONE:
// 7000 - Short scalp ðŸ”¥
// 6950 - Major magnet ðŸ”¥ (big customer long)
// 6930 - Reaction short / take profit zone ðŸ”¥
// 6885 - Breakout trigger â–²
//
// SHORT-GAMMA ZONE (6815-6880):
// 6880 - Cluster positioning
// 6870 - Heavy positioning cluster ðŸ‹ï¸
// 6850 - Cluster
// 6820 - LARGEST POSITION (PIN) ðŸŽ¯
// 6815 - Breakdown trigger â–¼
//
// SUPPORT ZONE:
// 6785 - Support 1 ðŸ§Š (reaction long)
// 6750 - Strong support ðŸ§Š (dealer long gamma)
// 6720 - Final shelf ðŸ§Š
//
// CURRENT CONTEXT:
// Market pinned to 6820 (largest position)
// Short-gamma zone 6815-6880 = consolidation/chop
// Breakout above 6885 targets 6930-6950-7000
// Breakdown below 6815 targets 6785-6750-6720

// === INPUTS ===
// High Resistance / Short Zone
level1 = input.float(7000, "R7 - Short scalp ðŸ”¥", group="ðŸ”´ High Resistance Zone")
level1_thickness = input.int(2, "R7 Line Thickness", minval=1, maxval=10, group="ðŸ”´ High Resistance Zone")
level2 = input.float(6950, "R6 - Major magnet ðŸ”¥ (big customer long)", group="ðŸ”´ High Resistance Zone")
level2_thickness = input.int(3, "R6 Line Thickness", minval=1, maxval=10, group="ðŸ”´ High Resistance Zone")
level3 = input.float(6930, "R5 - Reaction short / TP ðŸ”¥", group="ðŸ”´ High Resistance Zone")
level3_thickness = input.int(2, "R5 Line Thickness", minval=1, maxval=10, group="ðŸ”´ High Resistance Zone")
level4 = input.float(6885, "R4 - Breakout trigger â–²", group="ðŸ”´ High Resistance Zone")
level4_thickness = input.int(3, "R4 Line Thickness", minval=1, maxval=10, group="ðŸ”´ High Resistance Zone")

// Short-Gamma Zone
level5 = input.float(6880, "Gamma Top - 6880", group="âš¡ Short-Gamma Zone (6815-6880)")
level5_thickness = input.int(2, "6880 Line Thickness", minval=1, maxval=10, group="âš¡ Short-Gamma Zone (6815-6880)")
level6 = input.float(6870, "Heavy Cluster - 6870 ðŸ‹ï¸", group="âš¡ Short-Gamma Zone (6815-6880)")
level6_thickness = input.int(2, "6870 Line Thickness", minval=1, maxval=10, group="âš¡ Short-Gamma Zone (6815-6880)")
level7 = input.float(6850, "Gamma Mid - 6850", group="âš¡ Short-Gamma Zone (6815-6880)")
level7_thickness = input.int(2, "6850 Line Thickness", minval=1, maxval=10, group="âš¡ Short-Gamma Zone (6815-6880)")
level8 = input.float(6820, "LARGEST POSITION (PIN) ðŸŽ¯", group="âš¡ Short-Gamma Zone (6815-6880)")
level8_thickness = input.int(4, "6820 PIN Line Thickness", minval=1, maxval=10, group="âš¡ Short-Gamma Zone (6815-6880)")
level9 = input.float(6815, "Breakdown trigger â–¼", group="âš¡ Short-Gamma Zone (6815-6880)")
level9_thickness = input.int(3, "6815 Line Thickness", minval=1, maxval=10, group="âš¡ Short-Gamma Zone (6815-6880)")
level13 = input.float(6830, "6830 ðŸ» Bear Level", group="âš¡ Short-Gamma Zone (6815-6880)")
level13_thickness = input.int(2, "6830 Line Thickness", minval=1, maxval=10, group="âš¡ Short-Gamma Zone (6815-6880)")

// Support Zone
level10 = input.float(6785, "S1 - Support 1 ðŸ§Š (reaction long)", group="ðŸŸ¢ Support Zone")
level10_thickness = input.int(2, "S1 Line Thickness", minval=1, maxval=10, group="ðŸŸ¢ Support Zone")
level11 = input.float(6750, "S2 - Strong support ðŸ§Š (dealer long gamma)", group="ðŸŸ¢ Support Zone")
level11_thickness = input.int(3, "S2 Line Thickness", minval=1, maxval=10, group="ðŸŸ¢ Support Zone")
level12 = input.float(6720, "S3 - Final shelf ðŸ§Š", group="ðŸŸ¢ Support Zone")
level12_thickness = input.int(2, "S3 Line Thickness", minval=1, maxval=10, group="ðŸŸ¢ Support Zone")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="ðŸ”” Alert Settings")
alertSensitivity = input.float(5.0, "Alert Sensitivity", minval=0.1, maxval=10.0, group="ðŸ”” Alert Settings")

// Label Visibility
showLabels = input.bool(true, "Show Labels", group="ðŸ“Š Display Settings")
showLines = input.bool(true, "Show Level Lines", group="ðŸ“Š Display Settings")

// === LEVEL LINES ===
var line l1 = na
var line l2 = na
var line l3 = na
var line l4 = na
var line l5 = na
var line l6 = na
var line l7 = na
var line l8 = na
var line l9 = na
var line l10 = na
var line l11 = na
var line l12 = na
var line l13 = na

if showLines and barstate.islast
    // R7 - 7000 (Short scalp - Magenta, dashed)
    l1 := line.new(bar_index - 100, level1, bar_index + 20, level1, color=color.fuchsia, width=level1_thickness, style=line.style_dashed)
    
    // R6 - 6950 (Major magnet - Magenta)
    l2 := line.new(bar_index - 100, level2, bar_index + 20, level2, color=color.fuchsia, width=level2_thickness, style=line.style_solid)
    
    // R5 - 6930 (Reaction short/TP - Orange)
    l3 := line.new(bar_index - 100, level3, bar_index + 20, level3, color=color.orange, width=level3_thickness, style=line.style_solid)
    
    // R4 - 6885 (Breakout trigger - Yellow)
    l4 := line.new(bar_index - 100, level4, bar_index + 20, level4, color=color.yellow, width=level4_thickness, style=line.style_solid)
    
    // Short-Gamma Zone (Purple)
    l5 := line.new(bar_index - 100, level5, bar_index + 20, level5, color=color.purple, width=level5_thickness, style=line.style_solid)
    l6 := line.new(bar_index - 100, level6, bar_index + 20, level6, color=color.purple, width=level6_thickness, style=line.style_solid)
    l7 := line.new(bar_index - 100, level7, bar_index + 20, level7, color=color.purple, width=level7_thickness, style=line.style_solid)
    
    // 6820 PIN - Cyan, thick
    l8 := line.new(bar_index - 100, level8, bar_index + 20, level8, color=color.aqua, width=level8_thickness, style=line.style_solid)
    
    // 6815 Breakdown - Yellow
    l9 := line.new(bar_index - 100, level9, bar_index + 20, level9, color=color.yellow, width=level9_thickness, style=line.style_solid)
    
    // 6830 Bear Level - Orange
    l13 := line.new(bar_index - 100, level13, bar_index + 20, level13, color=color.orange, width=level13_thickness, style=line.style_solid)
    
    // Support Zone - Cyan
    l10 := line.new(bar_index - 100, level10, bar_index + 20, level10, color=color.aqua, width=level10_thickness, style=line.style_solid)
    l11 := line.new(bar_index - 100, level11, bar_index + 20, level11, color=color.aqua, width=level11_thickness, style=line.style_solid)
    l12 := line.new(bar_index - 100, level12, bar_index + 20, level12, color=color.aqua, width=level12_thickness, style=line.style_solid)

// === LABELS ===
if barstate.islast and showLabels
    label.new(bar_index + 20, level1, "7000 Short ðŸ”¥", style=label.style_label_left, color=color.fuchsia, textcolor=color.white)
    label.new(bar_index + 20, level2, "6950 Magnet ðŸ”¥", style=label.style_label_left, color=color.fuchsia, textcolor=color.white)
    label.new(bar_index + 20, level3, "6930 TP ðŸ”¥", style=label.style_label_left, color=color.orange, textcolor=color.white)
    label.new(bar_index + 20, level4, "6885 BO â–²", style=label.style_label_left, color=color.yellow, textcolor=color.black)
    label.new(bar_index + 20, level5, "6880 Gamma Top", style=label.style_label_left, color=color.purple, textcolor=color.white)
    label.new(bar_index + 20, level6, "6870 Heavy ðŸ‹ï¸", style=label.style_label_left, color=color.purple, textcolor=color.white)
    label.new(bar_index + 20, level7, "6850", style=label.style_label_left, color=color.purple, textcolor=color.white)
    label.new(bar_index + 20, level8, "6820 PIN ðŸŽ¯", style=label.style_label_center, color=color.aqua, textcolor=color.black, size=size.large)
    label.new(bar_index + 20, level9, "6815 BD â–¼", style=label.style_label_left, color=color.yellow, textcolor=color.black)
    label.new(bar_index + 20, level13, "6830 ðŸ»", style=label.style_label_left, color=color.orange, textcolor=color.white)
    label.new(bar_index + 20, level10, "6785 Sup ðŸ§Š", style=label.style_label_right, color=color.aqua, textcolor=color.black)
    label.new(bar_index + 20, level11, "6750 Sup ðŸ§Š", style=label.style_label_right, color=color.aqua, textcolor=color.black)
    label.new(bar_index + 20, level12, "6720 Shelf ðŸ§Š", style=label.style_label_right, color=color.aqua, textcolor=color.black)

// === POSITION DETECTION ===
above7000 = close > level1
at7000 = close >= level1 - 5 and close <= level1 + 5
above6950 = close > level2
at6950 = close >= level2 - 5 and close <= level2 + 5
above6930 = close > level3
at6930 = close >= level3 - 5 and close <= level3 + 5
above6885 = close > level4  // BREAKOUT TRIGGER
at6885 = close >= level4 - 5 and close <= level4 + 5
above6880 = close > level5
at6880 = close >= level5 - 5 and close <= level5 + 5
above6870 = close > level6
at6870 = close >= level6 - 5 and close <= level6 + 5
above6850 = close > level7
at6850 = close >= level7 - 5 and close <= level7 + 5
above6820 = close > level8  // PIVOT - PIN
at6820 = close >= level8 - 5 and close <= level8 + 5
below6820 = close < level8
above6815 = close > level9
at6815 = close >= level9 - 5 and close <= level9 + 5
below6815 = close < level9  // BREAKDOWN TRIGGER
above6830 = close > level13
at6830 = close >= level13 - 5 and close <= level13 + 5
below6830 = close < level13
above6785 = close > level10
at6785 = close >= level10 - 5 and close <= level10 + 5
above6750 = close > level11
at6750 = close >= level11 - 5 and close <= level11 + 5
above6720 = close > level12
at6720 = close >= level12 - 5 and close <= level12 + 5
below6720 = close < level12
inGammaZone = close >= level9 and close <= level5  // 6815-6880 short-gamma zone

// Volume spike detection
volSpike = volume > ta.sma(volume, 20) * 1.5

// === ALERT CONDITIONS ===

// HIGH RESISTANCE / SHORT ZONE
alertcondition(ta.crossover(close, level1), "7000 SHORT ZONE", "SPX >> 7000 ðŸ”¥ Short scalp zone!")
alertcondition(ta.crossover(close, level2), "6950 MAGNET", "SPX >> 6950 ðŸ”¥ Major magnet (big customer long)!")
alertcondition(ta.crossover(close, level3), "6930 TP ZONE", "SPX >> 6930 ðŸ”¥ Reaction short / TP zone!")

// BREAKOUT TRIGGER
alertcondition(ta.crossover(close, level4), "6885 BREAKOUT", "SPX UP 6885 â–² BREAKOUT TRIGGER - Watch 6930-6950!")
alertcondition(ta.crossunder(close, level4), "6885 REJECT", "SPX DOWN 6885 - Breakout rejected!")
alertcondition(at6885, "At 6885", "SPX at 6885 - Breakout trigger!")

// SHORT-GAMMA ZONE
alertcondition(inGammaZone, "In Gamma Zone", "SPX in short-gamma zone (6815-6880) - Expect chop!")
alertcondition(ta.crossover(close, level5), "6880 GAMMA TOP", "SPX >> 6880 - Gamma zone top!")
alertcondition(ta.crossover(close, level6), "6870 HEAVY CLUSTER", "SPX >> 6870 ðŸ‹ï¸ Heavy positioning cluster!")
alertcondition(ta.crossover(close, level7), "6850 GAMMA MID", "SPX >> 6850 - Gamma zone mid!")

// LARGEST POSITION (PIN)
alertcondition(at6820, "At 6820 PIN", "SPX >> 6820 ðŸŽ¯ LARGEST POSITION (PIN)!")
alertcondition(ta.cross(close, level8), "6820 PIN TOUCH", "SPX at 6820 - Pin level!")

// BREAKDOWN TRIGGER
alertcondition(ta.crossunder(close, level9), "6815 BREAKDOWN", "SPX DOWN 6815 â–¼ BREAKDOWN - Watch 6785!")
alertcondition(ta.crossover(close, level9), "6815 HOLD", "SPX UP 6815 - Holding breakdown trigger!")
alertcondition(below6815, "Below 6815", "SPX < 6815 - Breakdown triggered!")

// BEAR LEVEL 6830
alertcondition(ta.crossunder(close, level13), "6830 BEAR TEST", "SPX >> 6830 ðŸ» Bear level test!")
alertcondition(ta.crossover(close, level13), "6830 RECLAIM", "SPX UP 6830 ðŸ» Bear level reclaim!")
alertcondition(at6830, "At 6830", "SPX at 6830 ðŸ» Bear level!")

// SUPPORT ZONE
alertcondition(ta.crossunder(close, level10), "6785 SUPPORT 1", "SPX >> 6785 ðŸ§Š Support 1 (reaction long)!")
alertcondition(ta.crossunder(close, level11), "6750 STRONG SUPPORT", "SPX >> 6750 ðŸ§Š Strong support (dealer long gamma)!")
alertcondition(ta.crossunder(close, level12), "6720 FINAL SHELF", "SPX >> 6720 ðŸ§Š Final shelf!")
alertcondition(below6720, "Below 6720", "SPX < 6720 - Final shelf broken!")

// === STATUS TABLE ===
var table statusTable = table.new(position.top_right, 2, 20, border_width=1)

if barstate.islast and showLabels
    // Header
    table.cell(statusTable, 0, 0, "SPX DEC 1", bgcolor=color.new(color.blue, 70), text_color=color.white)
    table.cell(statusTable, 1, 0, str.tostring(close, "#.##"), bgcolor=color.new(color.blue, 70), text_color=color.white)
    
    // Alert Status
    table.cell(statusTable, 0, 1, "Alerts", text_color=color.white)
    table.cell(statusTable, 1, 1, enableAlerts ? "ON" : "OFF", bgcolor=enableAlerts ? color.green : color.red, text_color=color.white)
    
    // Bias based on 6820 PIN
    bias = above6885 ? "ðŸ“ˆ BREAKOUT" : inGammaZone ? "âš¡ GAMMA ZONE" : below6815 ? "ðŸ“‰ BREAKDOWN" : "ðŸŽ¯ AT PIN"
    biasColor = above6885 ? color.green : inGammaZone ? color.purple : below6815 ? color.red : color.aqua
    table.cell(statusTable, 0, 2, "Bias (6820)", text_color=color.white)
    table.cell(statusTable, 1, 2, bias, bgcolor=color.new(biasColor, 70), text_color=color.white)
    
    // Position Status
    position = above7000 ? "â†‘ 7000!" : above6950 ? "6950 Magnet" : above6930 ? "6930 TP" : above6885 ? "Above BO" : above6880 ? "Gamma Top" : above6870 ? "Heavy Cluster" : above6850 ? "Gamma Mid" : above6820 ? "Above PIN" : above6815 ? "At PIN" : above6785 ? "Support 1" : above6750 ? "Strong Sup" : above6720 ? "Final Shelf" : "Below Shelf"
    posColor = above7000 ? color.fuchsia : above6950 ? color.fuchsia : above6930 ? color.orange : above6885 ? color.yellow : above6815 ? color.purple : above6785 ? color.aqua : above6750 ? color.aqua : color.red
    table.cell(statusTable, 0, 3, "Position", text_color=color.white)
    table.cell(statusTable, 1, 3, position, bgcolor=color.new(posColor, 70), text_color=color.white)
    
    // Strategy
    strategy = above6885 ? "Watch 6930-6950-7000" : inGammaZone ? "Chop/Pin to 6820" : below6815 ? "Watch 6785-6750-6720" : "At PIN level"
    table.cell(statusTable, 0, 4, "Strategy", text_color=color.white)
    table.cell(statusTable, 1, 4, strategy, bgcolor=color.new(color.blue, 80), text_color=color.white)
    
    // Key Levels Summary
    table.cell(statusTable, 0, 5, "6820 PIN ðŸŽ¯", text_color=color.white)
    table.cell(statusTable, 1, 5, "Largest Position", bgcolor=color.new(color.aqua, 80), text_color=color.black)
    
    table.cell(statusTable, 0, 6, "Gamma Zone", text_color=color.white)
    table.cell(statusTable, 1, 6, "6815-6880", bgcolor=color.new(color.purple, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 7, "Breakout", text_color=color.white)
    table.cell(statusTable, 1, 7, "6885 â–²", bgcolor=color.new(color.yellow, 80), text_color=color.black)
    
    table.cell(statusTable, 0, 8, "Breakdown", text_color=color.white)
    table.cell(statusTable, 1, 8, "6815 â–¼", bgcolor=color.new(color.yellow, 80), text_color=color.black)
    
    // Distance to 6820 PIN
    distTo6820 = level8 - close
    distTo6820Str = distTo6820 > 0 ? "-" + str.tostring(math.abs(distTo6820), "#.#") : "+" + str.tostring(math.abs(distTo6820), "#.#")
    table.cell(statusTable, 0, 9, "To 6820 PIN", text_color=color.white)
    table.cell(statusTable, 1, 9, distTo6820Str, bgcolor=color.new(color.aqua, 80), text_color=color.black)
    
    // Distance to 6885 breakout
    distTo6885 = level4 - close
    distTo6885Str = distTo6885 > 0 ? "-" + str.tostring(math.abs(distTo6885), "#.#") : "+" + str.tostring(math.abs(distTo6885), "#.#")
    table.cell(statusTable, 0, 10, "To 6885 BO", text_color=color.white)
    table.cell(statusTable, 1, 10, distTo6885Str, bgcolor=color.new(color.yellow, 80), text_color=color.black)
    
    // Distance to 6815 breakdown
    distTo6815 = level9 - close
    distTo6815Str = distTo6815 > 0 ? "-" + str.tostring(math.abs(distTo6815), "#.#") : "+" + str.tostring(math.abs(distTo6815), "#.#")
    table.cell(statusTable, 0, 11, "To 6815 BD", text_color=color.white)
    table.cell(statusTable, 1, 11, distTo6815Str, bgcolor=color.new(color.yellow, 80), text_color=color.black)
    
    // Volume Status
    volStatus = volSpike ? "ðŸ”¥ SPIKE" : "Normal"
    volColor = volSpike ? color.orange : color.gray
    table.cell(statusTable, 0, 12, "Volume", text_color=color.white)
    table.cell(statusTable, 1, 12, volStatus, bgcolor=color.new(volColor, 70), text_color=color.white)
    
    // Market Context
    table.cell(statusTable, 0, 13, "Context", text_color=color.white)
    table.cell(statusTable, 1, 13, "Gamma Positioning", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 14, "Upside", text_color=color.white)
    table.cell(statusTable, 1, 14, "6885->6930->6950->7K", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 15, "Downside", text_color=color.white)
    table.cell(statusTable, 1, 15, "6815->6785->6750->6720", bgcolor=color.new(color.gray, 80), text_color=color.white)

// === PLOT INVISIBLE LINES FOR ALERT TRIGGERS ===
plot(level1, "R7: 7000", color=color.new(color.fuchsia, 100))
plot(level2, "R6: 6950", color=color.new(color.fuchsia, 100))
plot(level3, "R5: 6930", color=color.new(color.orange, 100))
plot(level4, "R4: 6885 BO", color=color.new(color.yellow, 100))
plot(level5, "Gamma: 6880", color=color.new(color.purple, 100))
plot(level6, "Gamma: 6870", color=color.new(color.purple, 100))
plot(level7, "Gamma: 6850", color=color.new(color.purple, 100))
plot(level8, "PIN: 6820", color=color.new(color.aqua, 100))
plot(level9, "BD: 6815", color=color.new(color.yellow, 100))
plot(level13, "Bear: 6830", color=color.new(color.orange, 100))
plot(level10, "S1: 6785", color=color.new(color.aqua, 100))
plot(level11, "S2: 6750", color=color.new(color.aqua, 100))
plot(level12, "S3: 6720", color=color.new(color.aqua, 100))

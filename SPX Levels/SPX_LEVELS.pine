//@version=5
indicator("SPX Levels: Strike-Based Positioning", overlay=true, max_lines_count=500, max_labels_count=500)

// === SPX Strike-Based Positioning - Updated 11/24/2025 ===
// 
// MARKET STRUCTURE (Strike-Based Positioning):
// Bull Max Target: 6920 (Low probability - needs all bear strikes cleared + dovish Fed)
// Hedge Fund Bear Shorts: 6880 (Sticky until EoY)
// 2nd Largest Bear Star: 6825 (Offense + Protection)
// Major Bear Star: 6765 (Breakdown players targeting 6520 fail)
// Late Hedgers: 6720 (will cover if breached)
// First Hedge Unwind: 6670
// Bull Entry Zone: 6600 (Current Christmas rally hopefuls)
// STOP LOSS CLUSTER: 6520 *** BREAK UNLEASHES FAST DROP ***
// Bear Targets if 6520 breaks: 6300-6060 (Flush zone)
//
// CURRENT CONTEXT:
// Market structure defined by strike positioning
// 6520 = Critical stop loss cluster
// Above 6600 = Christmas rally hopefuls in control
// 6670-6720 = Hedge unwind zone
// 6765+ = Bear shorts defending (targeting 6520 break)
//
// KEY STRIKE LEVELS:
// Resistance: 6670, 6720, 6765, 6825, 6880, 6920
// Support: 6600 (bull entry), 6520 (STOP CLUSTER)
// Flush Zone: 6300-6060 (if 6520 breaks)

// === INPUTS ===
// Resistance Levels
level1 = input.float(6920, "R6 - Bull Max Target (Low probability)", group="ðŸ”´ Resistance Levels")
level1_thickness = input.int(2, "R6 Line Thickness", minval=1, maxval=10, group="ðŸ”´ Resistance Levels")
level2 = input.float(6880, "R5 - Hedge Fund Bear Shorts (Sticky EoY)", group="ðŸ”´ Resistance Levels")
level2_thickness = input.int(3, "R5 Line Thickness", minval=1, maxval=10, group="ðŸ”´ Resistance Levels")
level3 = input.float(6825, "R4 - 2nd Largest Bear Star (Offense + Protection)", group="ðŸ”´ Resistance Levels")
level3_thickness = input.int(3, "R4 Line Thickness", minval=1, maxval=10, group="ðŸ”´ Resistance Levels")
level4 = input.float(6765, "R3 - Major Bear Star (Breakdown players)", group="ðŸ”´ Resistance Levels")
level4_thickness = input.int(4, "R3 Line Thickness", minval=1, maxval=10, group="ðŸ”´ Resistance Levels")
level5 = input.float(6720, "R2 - Late Hedgers (will cover if breached)", group="ðŸ”´ Resistance Levels")
level5_thickness = input.int(3, "R2 Line Thickness", minval=1, maxval=10, group="ðŸ”´ Resistance Levels")
level6 = input.float(6670, "R1 - First Hedge Unwind Trigger", group="ðŸ”´ Resistance Levels")
level6_thickness = input.int(3, "R1 Line Thickness", minval=1, maxval=10, group="ðŸ”´ Resistance Levels")

// Pivot Level
level7 = input.float(6600, "PIVOT - Bull Entry Zone (Christmas rally)", group="âš¡ Pivot")
level7_thickness = input.int(5, "PIVOT Line Thickness", minval=1, maxval=10, group="âš¡ Pivot")

// Support Levels
level8 = input.float(6520, "S1 - STOP LOSS CLUSTER *** CRITICAL ***", group="ðŸŸ¢ Support Levels")
level8_thickness = input.int(5, "S1 Line Thickness", minval=1, maxval=10, group="ðŸŸ¢ Support Levels")
level9 = input.float(6300, "S2 - Bear Target HIGH (flush zone)", group="ðŸŸ¢ Support Levels")
level9_thickness = input.int(2, "S2 Line Thickness", minval=1, maxval=10, group="ðŸŸ¢ Support Levels")
level10 = input.float(6060, "S3 - Bear Target LOW (flush zone)", group="ðŸŸ¢ Support Levels")
level10_thickness = input.int(2, "S3 Line Thickness", minval=1, maxval=10, group="ðŸŸ¢ Support Levels")

// Alert Settings
enableAlerts = input.bool(true, "Enable Alerts", group="ðŸ”” Alert Settings")
alertSensitivity = input.float(5.0, "Alert Sensitivity", minval=0.1, maxval=10.0, group="ðŸ”” Alert Settings")

// Label Visibility
showLabels = input.bool(true, "Show Labels", group="ðŸ“Š Display Settings")
showLines = input.bool(true, "Show Level Lines", group="ðŸ“Š Display Settings")

// === LEVEL LINES ===
var line l1 = na
var line l2 = na
var line l3 = na
var line l4 = na
var line l5 = na
var line l6 = na
var line l7 = na
var line l8 = na
var line l9 = na
var line l10 = na

if showLines and barstate.islast
    // R6 - 6920 (Bull Max - Cyan, dashed)
    l1 := line.new(bar_index - 100, level1, bar_index + 20, level1, color=color.aqua, width=level1_thickness, style=line.style_dashed)
    
    // R5 - 6880 (HF Bear Shorts - Magenta)
    l2 := line.new(bar_index - 100, level2, bar_index + 20, level2, color=color.fuchsia, width=level2_thickness, style=line.style_solid)
    
    // R4 - 6825 (2nd Bear Star - Plum)
    l3 := line.new(bar_index - 100, level3, bar_index + 20, level3, color=color.purple, width=level3_thickness, style=line.style_solid)
    
    // R3 - 6765 (Major Bear Star - Dark Orange)
    l4 := line.new(bar_index - 100, level4, bar_index + 20, level4, color=color.new(color.orange, 0), width=level4_thickness, style=line.style_solid)
    
    // R2 - 6720 (Late Hedgers - Orange)
    l5 := line.new(bar_index - 100, level5, bar_index + 20, level5, color=color.orange, width=level5_thickness, style=line.style_solid)
    
    // R1 - 6670 (Hedge Unwind - Yellow)
    l6 := line.new(bar_index - 100, level6, bar_index + 20, level6, color=color.yellow, width=level6_thickness, style=line.style_solid)
    
    // PIVOT - 6600 (Bull Entry - Green)
    l7 := line.new(bar_index - 100, level7, bar_index + 20, level7, color=color.lime, width=level7_thickness, style=line.style_solid)
    
    // S1 - 6520 (STOP CLUSTER - Red, thick)
    l8 := line.new(bar_index - 100, level8, bar_index + 20, level8, color=color.red, width=level8_thickness, style=line.style_solid)
    
    // S2 - 6300 (Bear Target - Dark Red, dashed)
    l9 := line.new(bar_index - 100, level9, bar_index + 20, level9, color=color.maroon, width=level9_thickness, style=line.style_dashed)
    
    // S3 - 6060 (Bear Target - Dark Red, dashed)
    l10 := line.new(bar_index - 100, level10, bar_index + 20, level10, color=color.maroon, width=level10_thickness, style=line.style_dashed)

// === LABELS ===
if barstate.islast and showLabels
    label.new(bar_index, level1, "Bull Max: 6920 (Low prob)", style=label.style_label_left, color=color.aqua, textcolor=color.white)
    label.new(bar_index, level2, "HF Bear Shorts: 6880 (Sticky EoY)", style=label.style_label_left, color=color.fuchsia, textcolor=color.white)
    label.new(bar_index, level3, "2nd Bear Star: 6825 (O+P)", style=label.style_label_left, color=color.purple, textcolor=color.white)
    label.new(bar_index, level4, "Major Bear: 6765 (BD->6520)", style=label.style_label_left, color=color.new(color.orange, 0), textcolor=color.white)
    label.new(bar_index, level5, "Late Hedge: 6720 (Cover)", style=label.style_label_left, color=color.orange, textcolor=color.white)
    label.new(bar_index, level6, "Hedge Unwind: 6670", style=label.style_label_left, color=color.yellow, textcolor=color.black)
    label.new(bar_index, level7, "Bull Entry: 6600 (Xmas Rally)", style=label.style_label_center, color=color.lime, textcolor=color.black, size=size.large)
    label.new(bar_index, level8, "STOP CLUSTER: 6520 *** CRITICAL ***", style=label.style_label_right, color=color.red, textcolor=color.white, size=size.large)
    label.new(bar_index, level9, "Bear Target: 6300 (Flush)", style=label.style_label_right, color=color.maroon, textcolor=color.white)
    label.new(bar_index, level10, "Bear Target: 6060 (Flush)", style=label.style_label_right, color=color.maroon, textcolor=color.white)

// === POSITION DETECTION ===
above6920 = close > level1
at6920 = close >= level1 - 5 and close <= level1 + 5
above6880 = close > level2
at6880 = close >= level2 - 5 and close <= level2 + 5
above6825 = close > level3
at6825 = close >= level3 - 5 and close <= level3 + 5
above6765 = close > level4
at6765 = close >= level4 - 5 and close <= level4 + 5
above6720 = close > level5
at6720 = close >= level5 - 5 and close <= level5 + 5
above6670 = close > level6
at6670 = close >= level6 - 5 and close <= level6 + 5
above6600 = close > level7  // BULLISH - Christmas rally zone
at6600 = close >= level7 - 5 and close <= level7 + 5  // PIVOT
below6600 = close < level7  // BEARISH - Below bull entry
above6520 = close > level8  // Above stop cluster
at6520 = close >= level8 - 10 and close <= level8 + 10  // STOP CLUSTER
below6520 = close < level8  // FAST DROP UNLEASHED
in6300_6060 = close >= level10 and close <= level9  // Flush zone
below6060 = close < level10

// Volume spike detection
volSpike = volume > ta.sma(volume, 20) * 1.5

// === ALERT CONDITIONS ===

// BULL MAX TARGET
alertcondition(ta.crossover(close, level1), "6920 BULL MAX", "SPX UP 6920 - Bull Max Target hit! Low probability!")
alertcondition(at6920, "At 6920", "SPX at 6920 - Bull max target!")

// HEDGE FUND BEAR SHORTS
alertcondition(ta.crossover(close, level2), "6880 HF SHORTS BREACH", "SPX UP 6880 - HF Bear Shorts breached!")
alertcondition(ta.crossunder(close, level2), "6880 HF SHORTS DEFEND", "SPX DOWN 6880 - HF Bear Shorts defending!")
alertcondition(at6880, "At 6880", "SPX at 6880 - HF Bear Shorts (Sticky EoY)")

// 2ND LARGEST BEAR STAR
alertcondition(ta.crossover(close, level3), "6825 2ND BEAR BREACH", "SPX UP 6825 - 2nd Bear Star breached!")
alertcondition(ta.crossunder(close, level3), "6825 2ND BEAR DEFEND", "SPX DOWN 6825 - 2nd Bear Star defending!")
alertcondition(at6825, "At 6825", "SPX at 6825 - 2nd Largest Bear Star!")

// MAJOR BEAR STAR - BREAKDOWN PLAYERS
alertcondition(ta.crossover(close, level4), "6765 MAJOR BEAR BREACH", "SPX UP 6765 - Major Bear Star breached!")
alertcondition(ta.crossunder(close, level4), "6765 BREAKDOWN DEFEND", "SPX DOWN 6765 - Breakdown players defending!")
alertcondition(at6765, "At 6765", "SPX at 6765 - Major Bear Star (targeting 6520)!")

// LATE HEDGERS
alertcondition(ta.crossover(close, level5), "6720 HEDGERS COVER", "SPX UP 6720 - Late Hedgers covering!")
alertcondition(ta.crossunder(close, level5), "6720 HEDGERS DEFEND", "SPX DOWN 6720 - Late Hedgers defending!")
alertcondition(at6720, "At 6720", "SPX at 6720 - Late Hedgers zone!")

// FIRST HEDGE UNWIND
alertcondition(ta.crossover(close, level6), "6670 HEDGE UNWIND", "SPX UP 6670 - Hedge Unwind triggered!")
alertcondition(ta.crossunder(close, level6), "6670 UNWIND REJECT", "SPX DOWN 6670 - Hedge Unwind rejected!")
alertcondition(at6670, "At 6670", "SPX at 6670 - First Hedge Unwind!")

// BULL ENTRY ZONE - PIVOT
alertcondition(ta.crossover(close, level7), "6600 CHRISTMAS RALLY", "SPX UP 6600 - Christmas rally zone! Bull entry!")
alertcondition(ta.crossunder(close, level7), "6600 BULL FAIL", "SPX DOWN 6600 - Bull entry failed!")
alertcondition(at6600, "At 6600 PIVOT", "SPX at 6600 - BULL ENTRY ZONE!")

// STOP LOSS CLUSTER - CRITICAL
alertcondition(ta.crossunder(close, level8), "6520 STOP CLUSTER BREACH", "SPX DOWN 6520 - STOP CLUSTER BREACH! FAST DROP UNLEASHED!")
alertcondition(ta.crossover(close, level8), "6520 STOP HOLD", "SPX UP 6520 - Stop cluster holding!")
alertcondition(at6520, "At 6520 STOP", "SPX at 6520 - *** STOP LOSS CLUSTER *** CRITICAL!")

// FLUSH ZONE
alertcondition(ta.crossunder(close, level9), "6300 FLUSH ZONE", "SPX DOWN 6300 - Entering flush zone!")
alertcondition(in6300_6060, "In Flush Zone", "SPX in 6300-6060 FLUSH ZONE!")

// STRATEGY ALERTS
alertcondition(above6600 and volSpike, "CHRISTMAS RALLY ACTIVE", "SPX >6600 + Volume! Christmas rally active!")
alertcondition(below6520, "FLUSH MODE", "SPX <6520 - FLUSH TO 6300-6060 ZONE!")

// === STATUS TABLE ===
var table statusTable = table.new(position.top_right, 2, 20, border_width=1)

if barstate.islast and showLabels
    // Header
    table.cell(statusTable, 0, 0, "SPX STRIKES", bgcolor=color.new(color.blue, 70), text_color=color.white)
    table.cell(statusTable, 1, 0, str.tostring(close, "#.##"), bgcolor=color.new(color.blue, 70), text_color=color.white)
    
    // Alert Status
    table.cell(statusTable, 0, 1, "Alerts", text_color=color.white)
    table.cell(statusTable, 1, 1, enableAlerts ? "ON" : "OFF", bgcolor=enableAlerts ? color.green : color.red, text_color=color.white)
    
    // Bias based on 6600 pivot
    bias = above6600 ? "ðŸ“ˆ BULLISH" : below6600 ? "ðŸ“‰ BEARISH" : "âš¡ PIVOT"
    biasColor = above6600 ? color.green : below6600 ? color.red : color.lime
    table.cell(statusTable, 0, 2, "Bias (6600)", text_color=color.white)
    table.cell(statusTable, 1, 2, bias, bgcolor=color.new(biasColor, 70), text_color=color.white)
    
    // Position Status
    position = above6920 ? "â†‘ Bull Max!" : above6880 ? "HF Bear Shorts" : above6825 ? "2nd Bear Star" : above6765 ? "Major Bear Star" : above6720 ? "Late Hedgers" : above6670 ? "Hedge Unwind" : above6600 ? "Christmas Rally" : above6520 ? "Below Bull Entry" : below6520 ? "âš ï¸ FLUSH MODE" : "At Stop Cluster"
    posColor = above6920 ? color.aqua : above6880 ? color.fuchsia : above6825 ? color.purple : above6765 ? color.new(color.orange, 0) : above6720 ? color.orange : above6670 ? color.yellow : above6600 ? color.lime : above6520 ? color.orange : color.red
    table.cell(statusTable, 0, 3, "Position", text_color=color.white)
    table.cell(statusTable, 1, 3, position, bgcolor=color.new(posColor, 70), text_color=color.white)
    
    // Strategy
    strategy = above6600 ? "Christmas rally hopefuls" : below6520 ? "FLUSH to 6300-6060!" : "Watch 6520 stop cluster"
    table.cell(statusTable, 0, 4, "Strategy", text_color=color.white)
    table.cell(statusTable, 1, 4, strategy, bgcolor=color.new(color.blue, 80), text_color=color.white)
    
    // Key Levels Summary
    table.cell(statusTable, 0, 5, "Bull Entry: 6600", text_color=color.white)
    table.cell(statusTable, 1, 5, "Hedge Unwind: 6670", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 6, "Late Hedge: 6720", text_color=color.white)
    table.cell(statusTable, 1, 6, "Major Bear: 6765", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 7, "2nd Bear: 6825", text_color=color.white)
    table.cell(statusTable, 1, 7, "HF Shorts: 6880", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 8, "STOP: 6520", text_color=color.white)
    table.cell(statusTable, 1, 8, "*** CRITICAL ***", bgcolor=color.new(color.red, 70), text_color=color.white)
    
    // Distance to 6600 pivot
    distTo6600 = level7 - close
    distTo6600Str = distTo6600 > 0 ? "-" + str.tostring(math.abs(distTo6600), "#.#") : "+" + str.tostring(math.abs(distTo6600), "#.#")
    table.cell(statusTable, 0, 9, "To 6600 PIVOT", text_color=color.white)
    table.cell(statusTable, 1, 9, distTo6600Str, bgcolor=color.new(color.lime, 80), text_color=color.black)
    
    // Distance to 6520 stop cluster
    distTo6520 = level8 - close
    distTo6520Str = distTo6520 > 0 ? "-" + str.tostring(math.abs(distTo6520), "#.#") : "+" + str.tostring(math.abs(distTo6520), "#.#")
    table.cell(statusTable, 0, 10, "To 6520 STOP", text_color=color.white)
    table.cell(statusTable, 1, 10, distTo6520Str, bgcolor=color.new(color.red, 80), text_color=color.white)
    
    // Distance to hedge unwind
    distTo6670 = level6 - close
    distTo6670Str = distTo6670 > 0 ? "-" + str.tostring(math.abs(distTo6670), "#.#") : "+" + str.tostring(math.abs(distTo6670), "#.#")
    table.cell(statusTable, 0, 11, "To 6670 Unwind", text_color=color.white)
    table.cell(statusTable, 1, 11, distTo6670Str, bgcolor=color.new(color.yellow, 80), text_color=color.black)
    
    // Volume Status
    volStatus = volSpike ? "ðŸ”¥ SPIKE" : "Normal"
    volColor = volSpike ? color.orange : color.gray
    table.cell(statusTable, 0, 12, "Volume", text_color=color.white)
    table.cell(statusTable, 1, 12, volStatus, bgcolor=color.new(volColor, 70), text_color=color.white)
    
    // Market Context
    table.cell(statusTable, 0, 13, "Context", text_color=color.white)
    table.cell(statusTable, 1, 13, "Strike Positioning", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    table.cell(statusTable, 0, 14, "Bear Target", text_color=color.white)
    table.cell(statusTable, 1, 14, "6520 break->6300", bgcolor=color.new(color.gray, 80), text_color=color.white)
    
    // Strike Structure
    table.cell(statusTable, 0, 15, "Structure", text_color=color.white)
    table.cell(statusTable, 1, 15, above6765 ? "Bear shorts defend" : "Xmas rally zone", bgcolor=color.new(color.gray, 80), text_color=color.white)

// === PLOT INVISIBLE LINES FOR ALERT TRIGGERS ===
plot(level1, "R6: 6920", color=color.new(color.aqua, 100))
plot(level2, "R5: 6880", color=color.new(color.fuchsia, 100))
plot(level3, "R4: 6825", color=color.new(color.purple, 100))
plot(level4, "R3: 6765", color=color.new(color.orange, 100))
plot(level5, "R2: 6720", color=color.new(color.orange, 100))
plot(level6, "R1: 6670", color=color.new(color.yellow, 100))
plot(level7, "PIVOT: 6600", color=color.new(color.lime, 100))
plot(level8, "S1: 6520 STOP", color=color.new(color.red, 100))
plot(level9, "S2: 6300", color=color.new(color.maroon, 100))
plot(level10, "S3: 6060", color=color.new(color.maroon, 100))
